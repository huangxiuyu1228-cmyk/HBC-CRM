<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>湖银客户管理系统 | HBC CRM</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10B981', 
                        secondary: '#34D399', 
                        glass: 'rgba(255, 255, 255, 0.25)', 
                        dark: '#064E3B',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'pop-in': 'popIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-in-right': 'slideInRight 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'blob': 'blob 20s infinite alternate',
                        'liquid': 'liquid 8s ease-in-out infinite',
                        'gradient-x': 'gradientX 15s ease infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(15px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.9) translateY(10px)' },
                            '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
                        },
                        slideInRight: {
                            '0%': { opacity: '0', transform: 'translateX(30px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        liquid: {
                            '0%, 100%': { borderRadius: '60% 40% 30% 70% / 60% 30% 70% 40%' },
                            '50%': { borderRadius: '30% 60% 70% 40% / 50% 60% 30% 60%' },
                        },
                        gradientX: {
                            '0%, 100%': { 'background-position': '0% 50%' },
                            '50%': { 'background-position': '100% 50%' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            /* 动态渐变背景作为底色 */
            background: linear-gradient(-45deg, #ecfdf5, #d1fae5, #eff6ff, #dbeafe);
            background-size: 400% 400%;
            animation: gradientX 15s ease infinite;
        }

        /* 隐藏滚动条 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- 3D 胶囊液态玻璃 (升级版) --- */
        .liquid-glass {
            /* 基础材质 */
            background: rgba(255, 255, 255, 0.45); 
            backdrop-filter: blur(30px) saturate(120%);
            -webkit-backdrop-filter: blur(30px) saturate(120%);
            
            /* 胶囊圆角 */
            border-radius: 2rem;
            
            /* 3D 边框光照模拟 */
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-top: 1.5px solid rgba(255, 255, 255, 0.8);
            border-left: 1.5px solid rgba(255, 255, 255, 0.8);
            
            /* 复合阴影制造厚度感 */
            box-shadow: 
                0 25px 45px rgba(0, 0, 0, 0.05), /* 外部投影 */
                inset 0 0 0 1px rgba(255, 255, 255, 0.2), /* 细微内描边 */
                inset 2px 2px 20px rgba(255, 255, 255, 0.5), /* 左上高光 */
                inset -2px -2px 20px rgba(0, 0, 0, 0.02); /* 右下暗部 */
            
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .liquid-glass-dark {
             background: rgba(255, 255, 255, 0.7);
             backdrop-filter: blur(40px) saturate(150%);
             -webkit-backdrop-filter: blur(40px) saturate(150%);
             border: 1px solid rgba(255, 255, 255, 0.5);
             border-top: 1px solid rgba(255, 255, 255, 0.9);
             box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.1), inset 0 0 20px rgba(255, 255, 255, 0.8);
        }

        /* 列表项飞入动画延迟 */
        .stagger-1 { animation-delay: 0.1s; }
        .stagger-2 { animation-delay: 0.2s; }
        .stagger-3 { animation-delay: 0.3s; }
        .stagger-4 { animation-delay: 0.4s; }
        .stagger-5 { animation-delay: 0.5s; }

        #login-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 0;
        }
        .video-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px); z-index: 1; /* 增加一点模糊，让背景更柔和 */
        }

        /* 悬停微动效 - 3D 浮起 */
        .hover-glass:hover { 
            transform: translateY(-6px) scale(1.01); 
            box-shadow: 
                0 30px 50px -10px rgba(16, 185, 129, 0.15), 
                inset 0 0 30px rgba(255, 255, 255, 0.9);
            border-color: rgba(255, 255, 255, 1);
            z-index: 10;
        }
        
        /* 移动端特定优化 */
        @media (max-width: 768px) {
            .liquid-glass {
                border-radius: 1.5rem; /* 移动端稍小的圆角适应屏幕 */
                backdrop-filter: blur(35px) saturate(130%); /* 移动端增强模糊 */
            }
        }
    </style>
</head>
<body class="text-gray-700 h-screen w-screen overflow-hidden relative selection:bg-green-200 selection:text-green-900">

    <!-- 高级动态流体背景 -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <!-- 基础渐变层 (已在 body 中定义) -->
        
        <!-- 动态光斑 (增强色彩以穿透磨砂玻璃) -->
        <div class="absolute top-[-10%] left-[-10%] w-[900px] h-[900px] bg-emerald-400/30 rounded-full mix-blend-multiply filter blur-[120px] animate-blob"></div>
        <div class="absolute top-[20%] right-[-20%] w-[700px] h-[700px] bg-blue-400/30 rounded-full mix-blend-multiply filter blur-[120px] animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-20%] left-[10%] w-[800px] h-[800px] bg-teal-300/30 rounded-full mix-blend-multiply filter blur-[120px] animate-blob animation-delay-4000"></div>
        <div class="absolute bottom-[30%] right-[10%] w-[500px] h-[500px] bg-cyan-200/40 rounded-full mix-blend-multiply filter blur-[100px] animate-blob animation-delay-3000"></div>
    </div>

    <!-- ==================== 1. 登录界面 ==================== -->
    <div id="login-page" class="absolute inset-0 z-50 flex items-center justify-center bg-white/20 transition-opacity duration-700 backdrop-blur-sm">
        <video id="login-video" autoplay muted loop playsinline>
            <source src="https://assets.mixkit.co/videos/preview/mixkit-white-abstract-technology-lines-2848-large.mp4" type="video/mp4">
        </video>
        <div class="video-overlay"></div>
        
        <div class="relative z-10 w-full max-w-md p-10 m-4 liquid-glass rounded-[3rem] animate-pop-in text-center border-white/60 shadow-2xl">
            <div class="absolute top-0 inset-x-0 h-px bg-gradient-to-r from-transparent via-white to-transparent opacity-80"></div>

            <div class="mb-10 relative">
                <div class="w-24 h-24 bg-gradient-to-br from-primary to-emerald-600 rounded-[2rem] mx-auto flex items-center justify-center mb-6 shadow-2xl shadow-green-500/30 rotate-3 hover:rotate-0 transition-all duration-500 border-[3px] border-white/40 ring-1 ring-black/5">
                    <i class="fa-solid fa-leaf text-4xl text-white drop-shadow-lg"></i>
                </div>
                <h1 class="text-4xl font-bold tracking-wider text-gray-800 mb-2 drop-shadow-sm">HBC CRM</h1>
                <p class="text-sm text-gray-600 font-medium tracking-[0.3em] uppercase opacity-80">Liquid Glass Edition</p>
            </div>

            <form id="login-form" class="space-y-6 text-left">
                <div class="group relative">
                    <input type="text" id="login-id" placeholder=" " class="peer w-full px-6 py-4 rounded-2xl bg-white/40 border border-white/50 text-gray-800 focus:bg-white/80 focus:border-primary focus:ring-4 focus:ring-green-100 outline-none transition-all shadow-inner" required>
                    <label class="absolute left-6 top-4 text-gray-400 text-sm transition-all peer-placeholder-shown:text-base peer-placeholder-shown:top-4 peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-primary peer-focus:bg-white/80 peer-focus:px-2 peer-focus:rounded-full pointer-events-none">工号 / ID</label>
                </div>
                <div class="group relative">
                    <input type="password" id="login-pwd" placeholder=" " class="peer w-full px-6 py-4 rounded-2xl bg-white/40 border border-white/50 text-gray-800 focus:bg-white/80 focus:border-primary focus:ring-4 focus:ring-green-100 outline-none transition-all shadow-inner" required>
                    <label class="absolute left-6 top-4 text-gray-400 text-sm transition-all peer-placeholder-shown:text-base peer-placeholder-shown:top-4 peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-primary peer-focus:bg-white/80 peer-focus:px-2 peer-focus:rounded-full pointer-events-none">密码 / PASSWORD</label>
                </div>
                <button type="submit" class="w-full py-4 bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-2xl font-bold text-white text-lg shadow-xl shadow-green-200 hover:shadow-green-400 hover:-translate-y-1 active:scale-95 transition-all duration-300 mt-4 border-t border-white/30 relative overflow-hidden group">
                    <span class="relative z-10">进入系统</span>
                    <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 rounded-2xl"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- ==================== 2. 主应用界面 ==================== -->
    <div id="app-container" class="hidden h-full flex flex-col md:flex-row relative z-10">
        
        <!-- PC 端侧边栏 -->
        <aside class="hidden md:flex flex-col w-72 liquid-glass h-[96%] z-20 m-4 my-auto rounded-[3rem] shadow-[0_20px_50px_rgba(0,0,0,0.05)] relative overflow-hidden">
            <div class="absolute -top-20 -left-20 w-40 h-40 bg-white/40 blur-3xl rounded-full pointer-events-none"></div>

            <div class="p-8 flex items-center gap-4 relative z-10">
                <div class="w-12 h-12 bg-gradient-to-br from-primary to-secondary rounded-2xl flex items-center justify-center text-white shadow-lg shadow-green-200 border border-white/30">
                    <i class="fa-solid fa-leaf text-xl"></i>
                </div>
                <span class="font-bold text-gray-800 text-2xl tracking-tight">湖银 CRM</span>
            </div>
            
            <nav class="flex-1 px-5 space-y-3 mt-4 relative z-10">
                <button onclick="router.navigate('overview')" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-gray-600 rounded-2xl transition-all duration-300 font-medium group relative overflow-hidden" data-page="overview">
                    <div class="absolute inset-0 bg-white/50 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-300 rounded-2xl"></div>
                    <i class="fa-solid fa-chart-pie w-6 text-center relative z-10 group-hover:scale-110 transition-transform text-gray-400 group-hover:text-primary"></i> 
                    <span class="relative z-10 group-hover:translate-x-1 transition-transform">概览</span>
                </button>
                <button onclick="router.navigate('customers')" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-gray-600 rounded-2xl transition-all duration-300 font-medium group relative overflow-hidden" data-page="customers">
                     <div class="absolute inset-0 bg-white/50 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-300 rounded-2xl"></div>
                    <i class="fa-solid fa-users w-6 text-center relative z-10 group-hover:scale-110 transition-transform text-gray-400 group-hover:text-primary"></i> 
                    <span class="relative z-10 group-hover:translate-x-1 transition-transform">客户管理</span>
                </button>
                <button onclick="router.navigate('transactions')" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-gray-600 rounded-2xl transition-all duration-300 font-medium group relative overflow-hidden" data-page="transactions">
                     <div class="absolute inset-0 bg-white/50 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-300 rounded-2xl"></div>
                    <i class="fa-solid fa-stream w-6 text-center relative z-10 group-hover:scale-110 transition-transform text-gray-400 group-hover:text-primary"></i> 
                    <span class="relative z-10 group-hover:translate-x-1 transition-transform">业务流水</span>
                </button>

                <div class="my-4 border-t border-gray-200/30 mx-4"></div>
                
                <button onclick="showBusinessModal()" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-gray-600 rounded-2xl transition-all duration-300 font-medium hover:bg-white/40 group">
                    <i class="fa-solid fa-plus-circle w-6 text-center text-emerald-500 group-hover:rotate-90 transition-transform"></i> 新增业务
                </button>
                <button onclick="showFollowupModal()" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-gray-600 rounded-2xl transition-all duration-300 font-medium hover:bg-white/40 group">
                    <i class="fa-solid fa-comment-dots w-6 text-center text-blue-500 group-hover:-translate-y-1 transition-transform"></i> 新增跟进
                </button>

                <button onclick="router.navigate('mine')" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-gray-600 rounded-2xl transition-all duration-300 font-medium mt-auto mb-4 group" data-page="mine">
                    <div class="w-8 h-8 rounded-full overflow-hidden border border-white/50 shadow-sm group-hover:ring-2 ring-primary transition-all bg-gray-100 flex items-center justify-center">
                         <i class="fa-solid fa-user text-xs"></i>
                    </div>
                    我的信息
                </button>
            </nav>
        </aside>

        <!-- 主内容区域 -->
        <main class="flex-1 h-full overflow-hidden flex flex-col relative">
            
            <!-- 顶部标题栏 -->
            <header class="px-6 py-6 md:px-8 md:py-8 flex justify-between items-center z-10">
                <div class="liquid-glass px-4 py-2 md:px-6 md:py-3 rounded-[1.5rem] inline-flex items-center gap-3 animate-fade-in shadow-sm border border-white/40">
                    <h2 id="page-title" class="text-xl md:text-2xl font-bold text-gray-800 tracking-tight">概览</h2>
                    <span class="w-px h-4 bg-gray-400/30"></span>
                    <p class="text-xs text-gray-500 font-mono" id="current-date">--</p>
                </div>
                <div class="flex items-center gap-4 animate-fade-in">
                    <div class="w-10 h-10 md:w-12 md:h-12 rounded-full liquid-glass flex items-center justify-center text-gray-500 hover:text-primary hover:bg-white cursor-pointer transition-all hover:shadow-lg hover:-translate-y-1 group" onclick="router.navigate('mine')">
                        <i class="fa-solid fa-bell group-hover:swing"></i>
                        <span class="absolute top-3 right-3 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white shadow-sm animate-pulse"></span>
                    </div>
                </div>
            </header>

            <!-- 动态内容容器 -->
            <div id="content-area" class="flex-1 overflow-y-auto px-4 md:px-8 pb-32 md:pb-8 no-scrollbar scroll-smooth">
                <!-- JS 动态注入 -->
            </div>

            <!-- 移动端底部导航栏 -->
            <nav class="md:hidden absolute bottom-6 left-4 right-4 liquid-glass-dark rounded-[2.5rem] py-2 z-30 flex justify-around items-center shadow-2xl border-t border-white/40 backdrop-blur-xl">
                <button onclick="router.navigate('overview')" class="nav-item-m flex-1 py-3 flex flex-col items-center gap-1 text-[10px] text-gray-400 transition-colors" data-page="overview">
                    <i class="fa-solid fa-chart-pie text-lg"></i>
                    <span>概览</span>
                </button>
                <button onclick="router.navigate('customers')" class="nav-item-m flex-1 py-3 flex flex-col items-center gap-1 text-[10px] text-gray-400 transition-colors" data-page="customers">
                    <i class="fa-solid fa-users text-lg"></i>
                    <span>客户</span>
                </button>
                <!-- 中间新增业务按钮 -->
                <button onclick="showBusinessModal()" class="nav-item-m flex-1 py-3 flex flex-col items-center gap-1 text-[10px] text-gray-400 transition-colors">
                    <div class="w-10 h-10 bg-primary/20 rounded-2xl flex items-center justify-center text-primary mb-0.5 shadow-sm border border-primary/20"><i class="fa-solid fa-plus text-lg"></i></div>
                    <span>办业务</span>
                </button>
                <!-- 新增：跟进按钮 -->
                <button onclick="showFollowupModal()" class="nav-item-m flex-1 py-3 flex flex-col items-center gap-1 text-[10px] text-gray-400 transition-colors" data-page="followup">
                    <i class="fa-solid fa-comment-dots text-lg"></i>
                    <span>跟进</span>
                </button>
                <button onclick="router.navigate('mine')" class="nav-item-m flex-1 py-3 flex flex-col items-center gap-1 text-[10px] text-gray-400 transition-colors" data-page="mine">
                    <i class="fa-solid fa-user-circle text-lg"></i>
                    <span>我的</span>
                </button>
            </nav>

        </main>
    </div>

    <!-- ==================== 模态框 ==================== -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-gray-900/20 backdrop-blur-md z-40 transition-opacity duration-500" onclick="closeAllModals()"></div>

    <!-- 业务办理模态框 -->
    <div id="business-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
        <div class="pointer-events-auto w-full max-w-lg liquid-glass-dark rounded-[2.5rem] p-8 transform transition-all duration-300 animate-pop-in relative overflow-hidden">
             <div class="absolute -top-20 -right-20 w-60 h-60 bg-green-300/30 rounded-full blur-3xl pointer-events-none"></div>
            <div class="flex justify-between items-center mb-8 relative z-10">
                <div><h3 class="text-2xl font-bold text-gray-800" id="biz-modal-title">业务办理</h3></div>
                <button onclick="closeAllModals()" class="w-10 h-10 rounded-full bg-white/40 hover:bg-white text-gray-500 hover:text-red-500 flex items-center justify-center transition-all"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="space-y-5 relative z-10">
                 <!-- 隐藏ID用于修改 -->
                 <input type="hidden" id="biz-edit-id">
                 <div class="relative group">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 pl-2">选择客户</label>
                    <div class="flex gap-3">
                        <input type="text" id="biz-search-input" placeholder="输入姓名/手机号" class="w-full pl-4 py-3 rounded-xl bg-white/50 border border-white/60 focus:bg-white outline-none transition-all">
                        <button onclick="searchCustomerForBiz()" id="biz-search-btn" class="bg-primary text-white px-5 rounded-xl shadow-lg hover:shadow-xl transition-all"><i class="fa-solid fa-search"></i></button>
                    </div>
                    <div id="biz-search-results" class="hidden absolute top-full left-0 w-full bg-white/95 backdrop-blur shadow-xl rounded-xl mt-2 z-50 p-2 max-h-40 overflow-auto"></div>
                    <div id="biz-selected-customer" class="hidden mt-2 p-3 bg-green-50 rounded-xl text-sm flex justify-between items-center text-primary font-bold">
                        <span id="biz-customer-name"></span><i class="fa-solid fa-check-circle"></i>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="biz-amount" class="w-full px-4 py-3 rounded-xl bg-white/50 border border-white/60 focus:bg-white outline-none" placeholder="金额">
                    <input type="date" id="biz-date" class="w-full px-4 py-3 rounded-xl bg-white/50 border border-white/60 focus:bg-white outline-none">
                </div>
                <select id="biz-type" class="w-full px-4 py-3 rounded-xl bg-white/50 border border-white/60 focus:bg-white outline-none">
                    <option value="一年定期">一年定期</option><option value="两年定期">两年定期</option><option value="三年定期">三年定期</option><option value="通知存款">通知存款</option><option value="自营理财">自营理财</option><option value="代销理财">代销理财</option><option value="扫码付">扫码付</option><option value="消费贷">消费贷</option><option value="按揭贷">按揭贷</option>
                </select>
                <textarea id="biz-remark" rows="2" class="w-full px-4 py-3 rounded-xl bg-white/50 border border-white/60 focus:bg-white outline-none" placeholder="备注"></textarea>
                <button onclick="saveTransaction()" class="w-full py-4 bg-gradient-to-r from-primary to-secondary text-white rounded-xl font-bold shadow-lg hover:-translate-y-1 transition-all">保存业务</button>
            </div>
        </div>
    </div>
    
    <!-- 跟进模态框 -->
    <div id="followup-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
        <div class="pointer-events-auto w-full max-w-lg liquid-glass-dark rounded-[2.5rem] p-8 animate-pop-in relative">
             <div class="flex justify-between items-center mb-6"><h3>新增跟进</h3><button onclick="closeAllModals()"><i class="fa-solid fa-times"></i></button></div>
             <div class="space-y-4">
                 <input type="text" id="fu-search-input" placeholder="客户姓名" class="w-full p-3 rounded-xl bg-white/50">
                 <button onclick="searchCustomerForFu()" class="hidden">Search</button>
                 <div id="fu-search-results" class="hidden bg-white p-2 absolute z-10 shadow-xl rounded-xl"></div>
                 <div id="fu-selected-customer" class="hidden text-blue-600 font-bold"></div>
                 <div class="grid grid-cols-4 gap-2 text-xs" id="fu-type-grid">
                     <div onclick="selectFuType(this, '电话回访')" class="bg-white/50 p-2 text-center rounded-lg cursor-pointer">电话</div>
                     <div onclick="selectFuType(this, '微信沟通')" class="bg-white/50 p-2 text-center rounded-lg cursor-pointer">微信</div>
                     <div onclick="selectFuType(this, '上门拜访')" class="bg-white/50 p-2 text-center rounded-lg cursor-pointer">上门</div>
                     <div onclick="selectFuType(this, '网点接待')" class="bg-white/50 p-2 text-center rounded-lg cursor-pointer">网点</div>
                 </div>
                 <input type="hidden" id="fu-type" value="电话回访">
                 <textarea id="fu-content" class="w-full p-3 rounded-xl bg-white/50" rows="3" placeholder="跟进内容"></textarea>
                 <button onclick="saveFollowup()" class="w-full py-3 bg-blue-500 text-white rounded-xl shadow-lg">保存</button>
             </div>
        </div>
    </div>

    <!-- 客户录入/修改模态框 -->
    <div id="add-customer-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
         <div class="pointer-events-auto w-full max-w-lg liquid-glass-dark rounded-[2.5rem] p-8 animate-pop-in max-h-[90vh] overflow-auto">
            <div class="flex justify-between mb-4">
                <h3 class="font-bold text-lg" id="cust-modal-title">录入客户</h3>
                <button onclick="closeAllModals()"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="cust-edit-id">
                <input id="cust-name" placeholder="姓名" class="w-full p-3 rounded-xl bg-white/50 border border-transparent focus:border-primary outline-none">
                <input id="cust-phone" placeholder="手机" class="w-full p-3 rounded-xl bg-white/50 border border-transparent focus:border-primary outline-none">
                <input id="cust-idcard" placeholder="身份证" class="w-full p-3 rounded-xl bg-white/50 border border-transparent focus:border-primary outline-none">
                <input id="cust-no" placeholder="客户号" class="w-full p-3 rounded-xl bg-white/50 border border-transparent focus:border-primary outline-none">
                <input id="cust-card" placeholder="卡号" class="w-full p-3 rounded-xl bg-white/50 border border-transparent focus:border-primary outline-none">
                <select id="cust-gender" class="w-full p-3 rounded-xl bg-white/50 border border-transparent focus:border-primary outline-none"><option value="男">男</option><option value="女">女</option></select>
                <select id="cust-source" class="w-full p-3 rounded-xl bg-white/50 border border-transparent focus:border-primary outline-none">
                    <option value="发单客户">发单客户</option><option value="系统分户">系统分户</option><option value="小红书客户">小红书客户</option><option value="公私联动客户">公私联动客户</option><option value="对公客户">对公客户</option><option value="资源客户">资源客户</option>
                </select>
                <button onclick="saveNewCustomer()" class="w-full py-3 bg-primary text-white rounded-xl shadow-lg">保存信息</button>
            </div>
         </div>
    </div>

    <!-- 客户详情模态框 -->
    <div id="customer-detail-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
        <div class="pointer-events-auto w-full max-w-4xl h-[85vh] liquid-glass-dark rounded-[3rem] shadow-2xl overflow-hidden animate-pop-in flex flex-col">
             <div class="bg-gradient-to-r from-emerald-500 to-teal-500 p-6 md:p-8 text-white relative flex-shrink-0">
                 <div class="absolute top-4 right-4 flex gap-3">
                     <!-- 详情页的操作按钮 -->
                     <button onclick="editCurrentCustomer()" class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/40 flex items-center justify-center backdrop-blur-sm"><i class="fa-solid fa-pen-to-square text-sm"></i></button>
                     <button onclick="deleteCurrentCustomer()" class="w-8 h-8 rounded-full bg-white/20 hover:bg-red-500/80 flex items-center justify-center backdrop-blur-sm"><i class="fa-solid fa-trash text-sm"></i></button>
                     <button onclick="closeAllModals()" class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/40 flex items-center justify-center backdrop-blur-sm"><i class="fa-solid fa-times text-sm"></i></button>
                 </div>
                 
                 <div class="flex items-center gap-4 mt-2">
                     <div id="detail-avatar" class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center text-2xl font-bold backdrop-blur-md border border-white/30"></div>
                     <div>
                         <h2 id="detail-name" class="text-2xl font-bold"></h2>
                         <p id="detail-id" class="text-sm opacity-80 font-mono"></p>
                     </div>
                 </div>
                 <div class="mt-6 flex justify-between md:justify-start md:gap-12">
                     <div><p class="text-xs opacity-70 uppercase tracking-wide">总资产</p><p id="detail-assets" class="text-2xl font-bold"></p></div>
                     <div><p class="text-xs opacity-70 uppercase tracking-wide">交易次数</p><p id="detail-tx-count" class="text-2xl font-bold"></p></div>
                     <div id="detail-level-badge" class="hidden md:block"></div>
                 </div>
             </div>
             
             <!-- 详情 Tab 内容 -->
             <div class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 bg-white/30 custom-scroll">
                 <!-- 基础信息 -->
                 <div id="detail-basic-info" class="liquid-glass p-5 rounded-2xl grid grid-cols-1 md:grid-cols-2 gap-4 text-sm border border-white/40"></div>
                 
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                     <!-- 业务流水 (修复移动端显示) -->
                     <div class="liquid-glass p-5 rounded-2xl min-h-[300px] flex flex-col border border-white/40">
                         <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2 border-b border-gray-200/50 pb-2">
                             <span class="w-1.5 h-5 bg-blue-500 rounded-full"></span> 业务流水
                         </h4>
                         <div id="detail-tx-list" class="flex-1 overflow-y-auto space-y-3 pr-1 custom-scroll"></div>
                     </div>

                     <!-- 跟进记录 -->
                     <div class="liquid-glass p-5 rounded-2xl min-h-[300px] flex flex-col border border-white/40">
                         <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2 border-b border-gray-200/50 pb-2">
                             <span class="w-1.5 h-5 bg-purple-500 rounded-full"></span> 跟进记录
                         </h4>
                         <div id="detail-fu-list" class="flex-1 overflow-y-auto space-y-3 pr-1 custom-scroll"></div>
                     </div>
                 </div>
             </div>
        </div>
    </div>


    <script>
        // ==================== 1. 数据逻辑 ====================
        const STORE_KEY = 'hbc_crm_v7_mobile_opt';
        
        function generateMockHistory() {
            const types = ['一年定期', '两年定期', '三年定期', '通知存款', '自营理财', '代销理财', '扫码付', '消费贷', '按揭贷'];
            const txs = [];
            const today = new Date();
            for(let i=0; i<30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const count = Math.floor(Math.random() * 4);
                for(let j=0; j<count; j++) {
                    txs.push({
                        id: `mock_${i}_${j}`,
                        custId: (Math.floor(Math.random() * 3) + 1).toString(),
                        amount: Math.floor(Math.random() * 200000) + 1000,
                        type: types[Math.floor(Math.random() * types.length)],
                        date: dateStr,
                        remark: '系统生成历史数据'
                    });
                }
            }
            return txs.sort((a,b) => new Date(b.date) - new Date(a.date));
        }

        const defaultData = {
            customers: [
                { id: '1', name: '王富贵', gender: '男', phone: '13800138000', idcard: '420101198001011234', custNo: 'C001', assets: 550000, source: '发单客户' },
                { id: '2', name: '李淑芬', gender: '女', phone: '13900139000', idcard: '420101198502025678', custNo: 'C002', assets: 120000, source: '系统分户' },
                { id: '3', name: '张伟', gender: '男', phone: '13700137000', idcard: '420101199003039876', custNo: 'C003', assets: 30000, source: '小红书客户' },
            ],
            transactions: [
                { id: 't1', custId: '1', amount: 50000, type: '三年定期', date: new Date().toISOString().split('T')[0], remark: '今日首单' }, 
                ...generateMockHistory()
            ],
            followups: [
                { id: 'f1', custId: '1', type: '电话回访', content: '客户表示对新的大额存单感兴趣', date: '2023-10-28 10:00' }
            ],
            currentUser: null
        };

        const db = {
            data: null,
            init() {
                const stored = localStorage.getItem(STORE_KEY);
                if (stored) {
                    this.data = JSON.parse(stored);
                } else {
                    this.data = JSON.parse(JSON.stringify(defaultData)); 
                    this.save();
                }
            },
            save() {
                localStorage.setItem(STORE_KEY, JSON.stringify(this.data));
            },
            addCustomer(c) { c.id = Date.now().toString(); c.assets=0; this.data.customers.unshift(c); this.save(); },
            updateCustomer(c) {
                const idx = this.data.customers.findIndex(x => x.id === c.id);
                if (idx !== -1) {
                    this.data.customers[idx] = { ...this.data.customers[idx], ...c };
                    this.save();
                }
            },
            deleteCustomer(id) {
                this.data.customers = this.data.customers.filter(c => c.id !== id);
                this.data.transactions = this.data.transactions.filter(t => t.custId !== id);
                this.data.followups = this.data.followups.filter(f => f.custId !== id);
                this.save();
            },
            addTransaction(t) { 
                t.id = 't'+Date.now(); 
                this.data.transactions.unshift(t); 
                this.recalcAssets(t.custId);
                this.save(); 
            },
            updateTransaction(t) {
                const idx = this.data.transactions.findIndex(x => x.id === t.id);
                if (idx !== -1) {
                    this.data.transactions[idx] = { ...this.data.transactions[idx], ...t };
                    this.recalcAssets(t.custId);
                    this.save();
                }
            },
            recalcAssets(custId) {
                const c = this.data.customers.find(x=>x.id===custId);
                if(c) {
                    const total = this.data.transactions.filter(tx => tx.custId === custId).reduce((sum, tx) => sum + parseFloat(tx.amount), 0);
                    c.assets = total;
                }
            },
            addFollowup(f) { f.id='f'+Date.now(); f.date=new Date().toLocaleString(); this.data.followups.unshift(f); this.save(); },
            getStats() {
                const todayStr = new Date().toISOString().split('T')[0];
                const todayTx = this.data.transactions.filter(t => t.date === todayStr);
                const totalAmount = this.data.transactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                return {
                    todayAmount: todayTx.reduce((sum, t) => sum + parseFloat(t.amount), 0),
                    totalAmount: totalAmount,
                    customerCount: this.data.customers.length,
                    txCount: this.data.transactions.length
                };
            }
        };

        // ==================== Router & View ====================
        const router = {
            currentPage: 'login',
            navigate(page) {
                this.currentPage = page;
                document.querySelectorAll('.nav-item, .nav-item-m').forEach(el => {
                    const active = el.dataset.page === page;
                    if(el.classList.contains('nav-item')) {
                        if(active) {
                            el.classList.add('bg-white/50', 'text-primary', 'shadow-sm', 'backdrop-blur-md');
                            el.classList.remove('text-gray-600');
                        } else {
                            el.classList.remove('bg-white/50', 'text-primary', 'shadow-sm', 'backdrop-blur-md');
                            el.classList.add('text-gray-600');
                        }
                    } else {
                        // Mobile nav
                        if(active) {
                            el.classList.add('text-primary');
                            el.classList.remove('text-gray-400');
                        } else {
                            el.classList.remove('text-primary');
                            el.classList.add('text-gray-400');
                        }
                    }
                });

                document.getElementById('page-title').innerText = 
                    page === 'overview' ? '工作概览' : 
                    page === 'customers' ? '客户管理' : 
                    page === 'transactions' ? '业务流水' : 
                    page === 'mine' ? '个人中心' : 'CRM';

                const container = document.getElementById('content-area');
                container.innerHTML = '';
                container.classList.remove('animate-fade-in');
                void container.offsetWidth; 
                container.classList.add('animate-fade-in');

                switch(page) {
                    case 'overview': renderOverview(container); break;
                    case 'customers': renderCustomers(container); break;
                    case 'transactions': renderTransactions(container); break;
                    case 'mine': renderMine(container); break;
                }
            }
        };

        // --- Overview (优化胶囊UI) ---
        function renderOverview(container) {
            const stats = db.getStats();
            let todayCardClass = "bg-gradient-to-br from-red-400 to-rose-500 shadow-red-200"; 
            let todayIcon = "fa-chart-line";
            if (stats.todayAmount > 100000) {
                todayCardClass = "bg-gradient-to-br from-emerald-400 to-green-600 shadow-green-200"; 
                todayIcon = "fa-arrow-trend-up";
            } else if (stats.todayAmount > 0) {
                todayCardClass = "bg-gradient-to-br from-amber-300 to-orange-500 shadow-orange-200"; 
                todayIcon = "fa-coins";
            }

            const html = `
                <div class="space-y-6">
                    <!-- 顶部卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                        <div class="${todayCardClass} text-white p-5 md:p-6 rounded-[2rem] shadow-xl relative overflow-hidden group hover-glass border border-white/20 min-h-[140px] flex flex-col justify-center">
                            <div class="absolute top-[-50%] right-[-50%] w-64 h-64 bg-white/20 rounded-full blur-3xl animate-blob"></div>
                            <div class="relative z-10">
                                <p class="text-white/80 text-xs md:text-sm font-medium mb-1 tracking-wider">今日业绩</p>
                                <h3 class="text-3xl md:text-4xl font-bold tracking-tight drop-shadow-sm">¥${stats.todayAmount.toLocaleString()}</h3>
                            </div>
                            <div class="absolute -right-2 -bottom-2 text-white/20 text-7xl md:text-8xl"><i class="fa-solid ${todayIcon}"></i></div>
                        </div>
                        
                        <div class="liquid-glass p-5 md:p-6 rounded-[2rem] hover-glass relative group min-h-[100px] flex flex-col justify-center">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 md:w-10 md:h-10 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-vault"></i></div>
                                <p class="text-gray-500 text-xs md:text-sm font-bold">累计金额</p>
                            </div>
                            <h3 class="text-xl md:text-2xl font-bold text-gray-800">¥${stats.totalAmount.toLocaleString()}</h3>
                        </div>

                        <div class="grid grid-cols-2 gap-4 md:contents">
                            <div onclick="router.navigate('customers')" class="liquid-glass p-4 md:p-6 rounded-[2rem] hover-glass cursor-pointer relative group border-l-4 border-l-orange-400 min-h-[100px] flex flex-col justify-center">
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="fa-solid fa-users text-orange-500"></i>
                                    <p class="text-gray-500 text-xs font-bold">客户</p>
                                </div>
                                <h3 class="text-xl md:text-2xl font-bold text-gray-800">${stats.customerCount}</h3>
                            </div>

                            <div onclick="router.navigate('transactions')" class="liquid-glass p-4 md:p-6 rounded-[2rem] hover-glass cursor-pointer relative group border-l-4 border-l-purple-400 min-h-[100px] flex flex-col justify-center">
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="fa-solid fa-list-check text-purple-500"></i>
                                    <p class="text-gray-500 text-xs font-bold">笔数</p>
                                </div>
                                <h3 class="text-xl md:text-2xl font-bold text-gray-800">${stats.txCount}</h3>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                        <div class="liquid-glass rounded-[2rem] md:rounded-[2.5rem] p-4 md:p-6 min-h-[350px] md:min-h-[400px] flex flex-col">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><span class="w-1.5 h-5 bg-primary rounded-full"></span> 业务分布</h3>
                            <div id="chart-pie" class="flex-1 w-full h-full"></div>
                        </div>
                        <div class="liquid-glass rounded-[2rem] md:rounded-[2.5rem] p-4 md:p-6 min-h-[350px] md:min-h-[400px] flex flex-col">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><span class="w-1.5 h-5 bg-blue-500 rounded-full"></span> 业绩趋势</h3>
                            <div id="chart-line" class="flex-1 w-full h-full"></div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = html;
            setTimeout(initCharts, 100);
        }

        // --- Charts ---
        function initCharts() {
            // (Same chart logic as before)
            const typeCounts = {}; db.data.transactions.forEach(t => { typeCounts[t.type] = (typeCounts[t.type] || 0) + 1; });
            const pieData = Object.keys(typeCounts).map(k => ({ value: typeCounts[k], name: k }));
            const dateAmounts = {}; const dates = [];
            for(let i=29; i>=0; i--) { const d = new Date(); d.setDate(d.getDate() - i); const str = d.toISOString().split('T')[0]; dates.push(str); dateAmounts[str] = 0; }
            db.data.transactions.forEach(t => { if(dateAmounts[t.date] !== undefined) { dateAmounts[t.date] += parseFloat(t.amount); } });
            const lineData = dates.map(d => dateAmounts[d]);

            const pieChart = echarts.init(document.getElementById('chart-pie'));
            pieChart.setOption({
                tooltip: { trigger: 'item' },
                series: [{ type: 'pie', radius: ['40%', '70%'], itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 }, data: pieData }]
            });
            const lineChart = echarts.init(document.getElementById('chart-line'));
            lineChart.setOption({
                tooltip: { trigger: 'axis' },
                grid: { left: '2%', right: '2%', bottom: '2%', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: dates.map(d => d.slice(5)), axisLine: { lineStyle: { color: '#9ca3af' } } },
                yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#e5e7eb' } } },
                series: [{ type: 'line', smooth: true, showSymbol: false, lineStyle: { width: 3, color: '#34D399' }, areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(52, 211, 153, 0.5)' }, { offset: 1, color: 'rgba(52, 211, 153, 0.05)' }]) }, data: lineData }]
            });
            window.addEventListener('resize', () => { pieChart.resize(); lineChart.resize(); });
        }

        // --- Render Transactions ---
        function renderTransactions(container) {
            const sortedTxs = [...db.data.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
            const html = `
                <div class="h-full flex flex-col">
                    <div class="sticky top-0 z-20 pb-4 backdrop-blur-sm pt-2">
                        <div class="liquid-glass px-6 py-4 rounded-2xl flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-stream mr-2 text-primary"></i> 业务流水</h2>
                            <span class="text-sm text-gray-500">共 ${sortedTxs.length} 笔</span>
                        </div>
                    </div>
                    
                    <div class="relative flex-1 pb-24 px-2 md:px-4">
                        <div class="absolute left-6 md:left-8 top-0 bottom-0 w-0.5 bg-gradient-to-b from-primary/50 to-transparent z-0"></div>
                        <div class="space-y-4 md:space-y-6 relative z-10">
                            ${sortedTxs.map((t, index) => {
                                const cust = db.data.customers.find(c => c.id === t.custId);
                                return `
                                <div class="flex gap-4 md:gap-6 items-start animate-fade-in stagger-${index%5+1}" style="animation-delay: ${index * 0.1}s">
                                    <div class="w-4 h-4 md:w-8 md:h-8 rounded-full bg-white border-4 border-primary shadow-lg flex-shrink-0 relative z-20 mt-3 md:mt-1 ml-2 md:ml-0"></div>
                                    <div class="flex-1 liquid-glass p-4 md:p-5 rounded-2xl hover-glass cursor-pointer border border-white/40">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <h4 class="font-bold text-gray-800 text-base md:text-lg flex items-center gap-2">
                                                    ${t.type}
                                                    <i class="fa-solid fa-pen text-xs text-gray-300 hover:text-primary p-1" onclick="event.stopPropagation(); openEditTransactionModal('${t.id}')"></i>
                                                </h4>
                                                <p class="text-xs text-gray-500 flex items-center gap-1 mt-1">
                                                    <span class="bg-white/50 px-1.5 py-0.5 rounded">${t.date}</span>
                                                    <i class="fa-solid fa-user ml-1"></i> ${cust ? cust.name : '未知'}
                                                </p>
                                            </div>
                                            <span class="font-bold text-lg md:text-xl text-primary font-mono">+${parseInt(t.amount).toLocaleString()}</span>
                                        </div>
                                        ${t.remark ? `<div class="bg-white/40 p-2 rounded-lg text-xs md:text-sm text-gray-600 mt-2 line-clamp-2"><i class="fa-solid fa-quote-left text-gray-400 mr-2"></i>${t.remark}</div>` : ''}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // --- Render Customers ---
        function renderCustomers(container) {
            const html = `
                <div class="space-y-6 h-full flex flex-col">
                    <div class="flex gap-3 md:gap-4 sticky top-0 z-10 pb-2 pt-2">
                         <div class="flex-1 liquid-glass flex items-center px-4 md:px-6 rounded-2xl focus-within:bg-white/60 transition-all border border-white/40 shadow-sm">
                            <i class="fa-solid fa-search text-gray-400 mr-3"></i>
                            <input type="text" id="cust-list-search" placeholder="搜索姓名 / 客户号" class="w-full py-3 md:py-4 outline-none text-sm bg-transparent" oninput="filterCustomerList(this.value)">
                        </div>
                        <button onclick="openAddCustomerModal()" class="bg-primary hover:bg-secondary text-white w-14 md:w-16 rounded-2xl shadow-lg flex items-center justify-center transition-all hover:scale-105 border-t border-white/20">
                            <i class="fa-solid fa-user-plus text-lg md:text-xl"></i>
                        </button>
                    </div>
                    <div id="customer-list-container" class="space-y-3 md:space-y-4 pb-24"></div>
                </div>
            `;
            container.innerHTML = html;
            filterCustomerList('');
        }

        function filterCustomerList(query) {
            const listContainer = document.getElementById('customer-list-container');
            if(!listContainer) return;
            const q = query.toLowerCase();
            const filtered = db.data.customers.filter(c => c.name.includes(q) || (c.custNo && c.custNo.includes(q)) || (c.idcard && c.idcard.includes(q)));
            
            function getLevelInfo(assets) {
                const amount = parseFloat(assets) || 0;
                if (amount >= 500000) return { name: '钻石', class: 'text-purple-600 bg-purple-100 border-purple-200', icon: 'fa-gem' };
                if (amount >= 200000) return { name: '白金', class: 'text-blue-600 bg-blue-100 border-blue-200', icon: 'fa-certificate' };
                if (amount >= 50000) return { name: '金卡', class: 'text-yellow-600 bg-yellow-100 border-yellow-200', icon: 'fa-crown' };
                return { name: '普通', class: 'text-gray-500 bg-gray-100 border-gray-200', icon: 'fa-user' };
            }

            listContainer.innerHTML = filtered.map((c, i) => {
                const level = getLevelInfo(c.assets);
                return `
                <div onclick="showCustomerDetail('${c.id}')" class="liquid-glass p-4 md:p-6 rounded-[1.5rem] md:rounded-[2rem] flex items-center justify-between cursor-pointer hover-glass group border border-white/40 animate-slide-in-right stagger-${i%5+1}" style="animation-delay: ${i*0.1}s">
                    <div class="flex items-center gap-4 md:gap-6">
                        <div class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-white/50 text-gray-500 flex items-center justify-center font-bold text-xl md:text-2xl group-hover:bg-primary group-hover:text-white transition-all shadow-inner border border-white">
                            ${c.name[0]}
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <h4 class="font-bold text-gray-800 text-base md:text-lg">${c.name}</h4>
                                <span class="text-[10px] px-2 py-0.5 rounded-full border shadow-sm backdrop-blur-sm ${level.class}"><i class="fa-solid ${level.icon} mr-1"></i>${level.name}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 font-mono tracking-wide bg-white/40 px-2 py-0.5 rounded inline-block">${c.custNo || '-'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-base md:text-lg font-bold text-gray-800 tracking-tight">¥${(c.assets || 0).toLocaleString()}</p>
                    </div>
                </div>
            `}).join('');
            if(filtered.length === 0) listContainer.innerHTML = `<div class="text-center py-20 text-gray-400">未找到匹配客户</div>`;
        }

        // ==================== Modal Logic (Enhanced for Edit/Delete) ====================
        let currentDetailCustomerId = null;

        function closeAllModals() { document.querySelectorAll('[id$="-modal"], #modal-overlay').forEach(el => el.classList.add('hidden')); }
        
        // --- Customer Logic ---
        function openAddCustomerModal() {
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('add-customer-modal').classList.remove('hidden');
            document.getElementById('cust-modal-title').innerText = '录入客户';
            document.getElementById('cust-edit-id').value = '';
            // Reset inputs
            ['cust-name','cust-phone','cust-idcard','cust-no','cust-card'].forEach(id => document.getElementById(id).value = '');
        }

        function editCurrentCustomer() {
            if(!currentDetailCustomerId) return;
            const c = db.data.customers.find(x => x.id === currentDetailCustomerId);
            closeAllModals(); // close detail modal
            openAddCustomerModal(); // open form
            // Fill data
            document.getElementById('cust-modal-title').innerText = '修改客户信息';
            document.getElementById('cust-edit-id').value = c.id;
            document.getElementById('cust-name').value = c.name;
            document.getElementById('cust-phone').value = c.phone;
            document.getElementById('cust-idcard').value = c.idcard || '';
            document.getElementById('cust-no').value = c.custNo || '';
            document.getElementById('cust-card').value = c.card || '';
            document.getElementById('cust-gender').value = c.gender || '男';
            document.getElementById('cust-source').value = c.source || '发单客户';
        }

        function saveNewCustomer() {
            const id = document.getElementById('cust-edit-id').value;
            const data = {
                name: document.getElementById('cust-name').value,
                phone: document.getElementById('cust-phone').value,
                idcard: document.getElementById('cust-idcard').value,
                custNo: document.getElementById('cust-no').value,
                card: document.getElementById('cust-card').value,
                gender: document.getElementById('cust-gender').value,
                source: document.getElementById('cust-source').value
            };
            if(!data.name) return alert('请输入姓名');

            if(id) {
                // Update
                db.updateCustomer({id, ...data});
                alert('客户信息已更新');
            } else {
                // Add
                db.addCustomer(data);
                alert('客户录入成功');
            }
            closeAllModals();
            if(router.currentPage === 'customers') renderCustomers(document.getElementById('content-area'));
            if(id && id === currentDetailCustomerId) showCustomerDetail(id); // Re-open detail if editing
        }

        function deleteCurrentCustomer() {
            if(!currentDetailCustomerId) return;
            if(confirm('确定要删除该客户吗？这将同时删除该客户的所有业务和跟进记录，不可恢复。')) {
                db.deleteCustomer(currentDetailCustomerId);
                closeAllModals();
                renderCustomers(document.getElementById('content-area'));
                if(router.currentPage === 'overview') renderOverview(document.getElementById('content-area'));
            }
        }

        // --- Transaction Logic ---
        function showBusinessModal() {
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('business-modal').classList.remove('hidden');
            document.getElementById('biz-modal-title').innerText = '业务办理';
            document.getElementById('biz-edit-id').value = '';
            document.getElementById('biz-search-input').value='';
            document.getElementById('biz-amount').value='';
            document.getElementById('biz-remark').value='';
            document.getElementById('biz-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('biz-selected-customer').classList.add('hidden');
            // Show search elements
            document.getElementById('biz-search-input').parentElement.classList.remove('hidden');
        }

        function openEditTransactionModal(txId) {
            const tx = db.data.transactions.find(t => t.id === txId);
            if(!tx) return;
            const cust = db.data.customers.find(c => c.id === tx.custId);
            
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('business-modal').classList.remove('hidden');
            document.getElementById('biz-modal-title').innerText = '修改业务';
            document.getElementById('biz-edit-id').value = tx.id;
            
            // Lock customer selection in edit mode
            document.getElementById('biz-search-input').parentElement.classList.add('hidden');
            document.getElementById('biz-selected-customer').classList.remove('hidden');
            document.getElementById('biz-customer-name').innerText = cust ? cust.name : 'Unknown';
            
            document.getElementById('biz-amount').value = tx.amount;
            document.getElementById('biz-type').value = tx.type;
            document.getElementById('biz-date').value = tx.date;
            document.getElementById('biz-remark').value = tx.remark || '';
        }

        let selectedBizCustomer = null;
        function searchCustomerForBiz() {
            const q = document.getElementById('biz-search-input').value;
            const res = db.data.customers.filter(c=>c.name.includes(q)||c.phone.includes(q));
            const div = document.getElementById('biz-search-results');
            div.innerHTML = res.map(c=>`<div onclick="selectBizCust('${c.id}','${c.name}')" class="p-2 hover:bg-gray-100 cursor-pointer border-b">${c.name} - ${c.phone}</div>`).join('');
            div.classList.remove('hidden');
        }
        function selectBizCust(id, name) {
            selectedBizCustomer = id;
            document.getElementById('biz-customer-name').innerText = name;
            document.getElementById('biz-selected-customer').classList.remove('hidden');
            document.getElementById('biz-search-results').classList.add('hidden');
        }

        function saveTransaction() {
            const editId = document.getElementById('biz-edit-id').value;
            const data = {
                amount: document.getElementById('biz-amount').value,
                type: document.getElementById('biz-type').value,
                date: document.getElementById('biz-date').value,
                remark: document.getElementById('biz-remark').value
            };
            if(!data.amount) return alert('请输入金额');

            if(editId) {
                // Update
                const tx = db.data.transactions.find(t => t.id === editId);
                db.updateTransaction({id: editId, custId: tx.custId, ...data});
                alert('业务已修改');
            } else {
                // Add
                if(!selectedBizCustomer) return alert('请选择客户');
                db.addTransaction({custId: selectedBizCustomer, ...data});
                alert('业务办理成功');
            }
            closeAllModals();
            if(router.currentPage === 'transactions') renderTransactions(document.getElementById('content-area'));
            if(router.currentPage === 'overview') renderOverview(document.getElementById('content-area'));
            // If inside detail page, refresh it
            if(!document.getElementById('customer-detail-modal').classList.contains('hidden')) {
                showCustomerDetail(currentDetailCustomerId);
            }
        }

        // --- Detail Page ---
        function showCustomerDetail(id) { 
            currentDetailCustomerId = id;
            const c = db.data.customers.find(x=>x.id===id); if(!c) return;
            document.getElementById('customer-detail-modal').classList.remove('hidden');
            document.getElementById('detail-name').innerText = c.name;
            document.getElementById('detail-avatar').innerText = c.name[0];
            document.getElementById('detail-id').innerText = 'ID: ' + (c.custNo || '-');
            document.getElementById('detail-assets').innerText = '¥'+(c.assets||0).toLocaleString();
            
            document.getElementById('detail-basic-info').innerHTML = `
                <div><span class="text-gray-500 block text-xs">手机号码</span> ${c.phone}</div>
                <div><span class="text-gray-500 block text-xs">身份证号</span> ${c.idcard || '-'}</div>
                <div><span class="text-gray-500 block text-xs">客户来源</span> ${c.source || '-'}</div>
                <div><span class="text-gray-500 block text-xs">银行卡号</span> ${c.card || '-'}</div>
            `;

            // 业务流水 - 强制移动端列表格式优化 (Point 5)
            const txs = db.data.transactions.filter(t=>t.custId===id).sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('detail-tx-count').innerText = txs.length;
            
            if (txs.length > 0) {
                document.getElementById('detail-tx-list').innerHTML = `
                    <div class="space-y-3">
                        ${txs.map(t => `
                            <div class="bg-white/50 p-3 rounded-xl border border-white/60 shadow-sm flex flex-col gap-1 relative group">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold text-gray-800">${t.type}</span>
                                    <span class="font-bold text-primary font-mono text-lg">+${parseInt(t.amount).toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between items-center text-xs text-gray-500">
                                    <span><i class="fa-regular fa-clock mr-1"></i>${t.date}</span>
                                    <button onclick="openEditTransactionModal('${t.id}')" class="text-blue-500 bg-blue-50 px-2 py-0.5 rounded hover:bg-blue-100"><i class="fa-solid fa-pen"></i> 修改</button>
                                </div>
                                ${t.remark ? `<div class="text-xs text-gray-600 bg-gray-50 p-1.5 rounded mt-1 line-clamp-2">${t.remark}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                document.getElementById('detail-tx-list').innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">暂无业务记录</div>`;
            }
            
            // Followups (Simple list)
            const fus = db.data.followups.filter(f=>f.custId===id);
            document.getElementById('detail-fu-list').innerHTML = fus.length ? fus.map(f => `
                <div class="bg-white/50 p-3 rounded-xl border border-white/60 text-sm mb-2">
                    <div class="flex justify-between font-bold text-purple-700 mb-1"><span>${f.type}</span><span class="text-xs font-normal text-gray-400">${f.date.split(' ')[0]}</span></div>
                    <p class="text-gray-600">${f.content}</p>
                </div>
            `).join('') : '<div class="text-center py-8 text-gray-400 text-sm">暂无记录</div>';
        }

        // --- Other Helpers ---
        function showFollowupModal() { document.getElementById('modal-overlay').classList.remove('hidden'); document.getElementById('followup-modal').classList.remove('hidden'); }
        function selectFuType(el, type) { 
            document.getElementById('fu-type').value=type; 
            document.querySelectorAll('#fu-type-grid div').forEach(d=>d.classList.remove('bg-blue-100','text-blue-600'));
            el.classList.add('bg-blue-100','text-blue-600');
        }
        function searchCustomerForFu() { /* Simplified */ }
        function saveFollowup() { 
            const custId = selectedBizCustomer || db.data.customers[0]?.id; // Mock selection for simplicity if search skipped
            if(!custId) return alert('请选择客户');
            db.addFollowup({
                custId: custId,
                type: document.getElementById('fu-type').value,
                content: document.getElementById('fu-content').value
            });
            alert('跟进已保存'); 
            closeAllModals(); 
        }
        
        function renderMine(container) {
             const user = db.data.currentUser || { id: 'Unknown' };
             container.innerHTML = `
                <div class="space-y-8 animate-fade-in">
                    <div class="liquid-glass p-8 rounded-[3rem] text-center relative overflow-hidden border border-white/40 shadow-xl">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-green-200/40 rounded-full blur-3xl"></div>
                        <div class="w-24 h-24 bg-gradient-to-br from-primary to-emerald-600 text-white rounded-[2rem] mx-auto flex items-center justify-center text-4xl mb-4 shadow-lg rotate-3 border-4 border-white/30">
                            <i class="fa-solid fa-user-tie"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">客户经理</h2>
                        <p class="text-gray-500 mb-2 font-mono bg-white/40 inline-block px-3 py-1 rounded-lg">ID: ${user.id}</p>
                        <p class="text-xs text-gray-400">湖银总行营业部</p>
                    </div>

                    <div class="liquid-glass rounded-[2.5rem] overflow-hidden divide-y divide-gray-200/50 border border-white/40">
                        <div onclick="exportData()" class="p-6 hover:bg-white/40 cursor-pointer flex justify-between items-center transition-colors group">
                            <div class="flex items-center gap-5">
                                <div class="w-12 h-12 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center group-hover:scale-110 transition-transform shadow-sm"><i class="fa-solid fa-cloud-download-alt text-xl"></i></div>
                                <div>
                                    <span class="font-bold text-gray-700 text-lg block group-hover:text-blue-600 transition-colors">数据备份导出</span>
                                    <span class="text-xs text-gray-400">下载 JSON 数据文件</span>
                                </div>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center text-gray-400 group-hover:text-blue-600"><i class="fa-solid fa-angle-right"></i></div>
                        </div>
                        
                        <div class="p-6 hover:bg-white/40 cursor-pointer flex justify-between items-center relative transition-colors group">
                            <div class="flex items-center gap-5">
                                <div class="w-12 h-12 rounded-2xl bg-orange-50 text-orange-600 flex items-center justify-center group-hover:scale-110 transition-transform shadow-sm"><i class="fa-solid fa-cloud-upload-alt text-xl"></i></div>
                                <div>
                                    <span class="font-bold text-gray-700 text-lg block group-hover:text-orange-600 transition-colors">数据恢复导入</span>
                                    <span class="text-xs text-gray-400">点击上传 JSON 备份文件</span>
                                </div>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center text-gray-400 group-hover:text-orange-600"><i class="fa-solid fa-angle-right"></i></div>
                            <input type="file" onchange="importData(this)" class="absolute inset-0 opacity-0 cursor-pointer" accept=".json">
                        </div>
                        
                         <div onclick="if(confirm('确定要退出登录吗？')){db.data.currentUser=null;db.save();location.reload();}" class="p-6 hover:bg-red-50/50 cursor-pointer flex justify-between items-center group transition-colors">
                            <div class="flex items-center gap-5">
                                <div class="w-12 h-12 rounded-2xl bg-red-50 text-red-500 flex items-center justify-center group-hover:bg-red-500 group-hover:text-white transition-all shadow-sm"><i class="fa-solid fa-power-off text-xl"></i></div>
                                <span class="font-bold text-red-500 text-lg">安全退出</span>
                            </div>
                        </div>
                    </div>
                </div>
             `;
        }

        // --- Export/Import ---
        function exportData() {
            const dataStr = JSON.stringify(db.data);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', `HBC_CRM_Backup_${new Date().toISOString().slice(0,10)}.json`);
            linkElement.click();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(confirm('导入数据将覆盖当前所有数据，确定要继续吗？')) {
                        db.data = json;
                        db.save();
                        alert('数据恢复成功！页面即将刷新。');
                        location.reload();
                    }
                } catch(err) {
                    alert('文件格式错误，请上传正确的 JSON 备份文件。');
                }
            };
            reader.readAsText(file);
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            db.init();
            if(db.data.currentUser) {
                document.getElementById('login-page').style.display='none';
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('current-date').innerText = new Date().toLocaleDateString();
                router.navigate('overview');
            }
            document.getElementById('login-form').addEventListener('submit', (e)=>{
                e.preventDefault();
                const id = document.getElementById('login-id').value;
                if(id) {
                    document.getElementById('login-page').style.opacity='0';
                    setTimeout(()=>{
                        document.getElementById('login-page').style.display='none';
                        document.getElementById('app-container').classList.remove('hidden');
                        db.data.currentUser={id:id}; db.save();
                        router.navigate('overview');
                    }, 500);
                }
            })
        });
    </script>
</body>
</html>
