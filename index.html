<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>湖银客户管理系统 | HBC CRM</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10B981', 
                        secondary: '#34D399', 
                        glass: 'rgba(255, 255, 255, 0.25)', 
                        dark: '#064E3B',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'pop-in': 'popIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-in-right': 'slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'blob': 'blob 15s infinite',
                        'liquid': 'liquid 8s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(15px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.9) translateY(10px)' },
                            '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
                        },
                        slideInRight: {
                            '0%': { opacity: '0', transform: 'translateX(30px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(50px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-30px, 30px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        liquid: {
                            '0%, 100%': { borderRadius: '60% 40% 30% 70% / 60% 30% 70% 40%' },
                            '50%': { borderRadius: '30% 60% 70% 40% / 50% 60% 30% 60%' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #ECFDF5; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* 隐藏滚动条 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- 旗舰级液态玻璃样式 --- */
        .liquid-glass {
            background: rgba(255, 255, 255, 0.4); /* 基础透明度 */
            backdrop-filter: blur(40px) saturate(180%); /* 强模糊+高饱和 */
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            
            border-top: 1.5px solid rgba(255, 255, 255, 0.8);
            border-left: 1.5px solid rgba(255, 255, 255, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            
            box-shadow: 
                0 20px 40px -10px rgba(0, 0, 0, 0.05), 
                inset 0 0 0 1px rgba(255, 255, 255, 0.2), 
                inset 0 0 20px 5px rgba(255, 255, 255, 0.3); 
        }
        
        .liquid-glass-dark {
             background: rgba(255, 255, 255, 0.7);
             backdrop-filter: blur(50px);
             -webkit-backdrop-filter: blur(50px);
             border: 1px solid rgba(255, 255, 255, 0.6);
             box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }

        /* 列表项飞入动画延迟 */
        .stagger-1 { animation-delay: 0.05s; }
        .stagger-2 { animation-delay: 0.1s; }
        .stagger-3 { animation-delay: 0.15s; }
        .stagger-4 { animation-delay: 0.2s; }
        .stagger-5 { animation-delay: 0.25s; }

        /* 登录视频背景 */
        #login-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 0;
        }
        .video-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px); z-index: 1;
        }

        /* 悬停微动效 */
        .hover-glass { transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .hover-glass:hover { 
            transform: translateY(-4px) scale(1.01); 
            box-shadow: 0 20px 40px -5px rgba(16, 185, 129, 0.15), inset 0 0 30px rgba(255, 255, 255, 0.8);
            border-color: #fff;
        }
    </style>
</head>
<body class="text-gray-700 h-screen w-screen overflow-hidden relative selection:bg-green-200 selection:text-green-900">

    <!-- 动态流体背景 -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute top-[-20%] left-[-10%] w-[800px] h-[800px] bg-emerald-300/40 rounded-full mix-blend-multiply filter blur-[100px] animate-blob"></div>
        <div class="absolute top-[10%] right-[-20%] w-[600px] h-[600px] bg-blue-200/40 rounded-full mix-blend-multiply filter blur-[100px] animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-20%] left-[20%] w-[700px] h-[700px] bg-teal-200/40 rounded-full mix-blend-multiply filter blur-[100px] animate-blob animation-delay-4000"></div>
        <div class="absolute bottom-[20%] right-[10%] w-[400px] h-[400px] bg-purple-100/40 rounded-full mix-blend-multiply filter blur-[80px] animate-blob animation-delay-3000"></div>
    </div>

    <!-- ==================== 1. 登录界面 ==================== -->
    <div id="login-page" class="absolute inset-0 z-50 flex items-center justify-center bg-white/30 transition-opacity duration-700 backdrop-blur-sm">
        <video id="login-video" autoplay muted loop playsinline>
            <source src="https://assets.mixkit.co/videos/preview/mixkit-white-abstract-technology-lines-2848-large.mp4" type="video/mp4">
        </video>
        <div class="video-overlay"></div>
        
        <div class="relative z-10 w-full max-w-md p-10 m-4 liquid-glass rounded-[3rem] animate-pop-in text-center border-white/60 shadow-2xl">
            <div class="absolute top-0 inset-x-0 h-px bg-gradient-to-r from-transparent via-white to-transparent opacity-80"></div>

            <div class="mb-10 relative">
                <div class="w-24 h-24 bg-gradient-to-br from-primary to-emerald-600 rounded-[2rem] mx-auto flex items-center justify-center mb-6 shadow-2xl shadow-green-500/30 rotate-3 hover:rotate-0 transition-all duration-500 border-[3px] border-white/40 ring-1 ring-black/5">
                    <i class="fa-solid fa-leaf text-4xl text-white drop-shadow-lg"></i>
                </div>
                <h1 class="text-4xl font-bold tracking-wider text-gray-800 mb-2 drop-shadow-sm">HBC CRM</h1>
                <p class="text-sm text-gray-600 font-medium tracking-[0.3em] uppercase opacity-80">Liquid Glass Edition</p>
            </div>

            <form id="login-form" class="space-y-6 text-left">
                <div class="group relative">
                    <input type="text" id="login-id" placeholder=" " class="peer w-full px-6 py-4 rounded-2xl bg-white/40 border border-white/50 text-gray-800 focus:bg-white/80 focus:border-primary focus:ring-4 focus:ring-green-100 outline-none transition-all shadow-inner" required>
                    <label class="absolute left-6 top-4 text-gray-400 text-sm transition-all peer-placeholder-shown:text-base peer-placeholder-shown:top-4 peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-primary peer-focus:bg-white/80 peer-focus:px-2 peer-focus:rounded-full pointer-events-none">工号 / ID</label>
                </div>
                <div class="group relative">
                    <input type="password" id="login-pwd" placeholder=" " class="peer w-full px-6 py-4 rounded-2xl bg-white/40 border border-white/50 text-gray-800 focus:bg-white/80 focus:border-primary focus:ring-4 focus:ring-green-100 outline-none transition-all shadow-inner" required>
                    <label class="absolute left-6 top-4 text-gray-400 text-sm transition-all peer-placeholder-shown:text-base peer-placeholder-shown:top-4 peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-primary peer-focus:bg-white/80 peer-focus:px-2 peer-focus:rounded-full pointer-events-none">密码 / PASSWORD</label>
                </div>
                <button type="submit" class="w-full py-4 bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-2xl font-bold text-white text-lg shadow-xl shadow-green-200 hover:shadow-green-400 hover:-translate-y-1 active:scale-95 transition-all duration-300 mt-4 border-t border-white/30 relative overflow-hidden group">
                    <span class="relative z-10">进入系统</span>
                    <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 rounded-2xl"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- ==================== 2. 主应用界面 ==================== -->
    <div id="app-container" class="hidden h-full flex flex-col md:flex-row relative z-10">
        
        <!-- PC 端侧边栏 -->
        <aside class="hidden md:flex flex-col w-72 liquid-glass h-[96%] z-20 m-4 my-auto rounded-[3rem] shadow-[0_20px_50px_rgba(0,0,0,0.05)] relative overflow-hidden">
             <div class="absolute -top-20 -left-20 w-40 h-40 bg-white/40 blur-3xl rounded-full pointer-events-none"></div>

            <div class="p-8 flex items-center gap-4 relative z-10">
                <div class="w-12 h-12 bg-gradient-to-br from-primary to-secondary rounded-2xl flex items-center justify-center text-white shadow-lg shadow-green-200 border border-white/30">
                    <i class="fa-solid fa-leaf text-xl"></i>
                </div>
                <span class="font-bold text-gray-800 text-2xl tracking-tight">湖银 CRM</span>
            </div>
            
            <nav class="flex-1 px-5 space-y-3 mt-4 relative z-10">
                <button onclick="router.navigate('overview')" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-gray-600 rounded-2xl transition-all duration-300 font-medium group relative overflow-hidden" data-page="overview">
                    <div class="absolute inset-0 bg-white/50 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-300 rounded-2xl"></div>
                    <i class="fa-solid fa-chart-pie w-6 text-center relative z-10 group-hover:scale-110 transition-transform text-gray-400 group-hover:text-primary"></i> 
                    <span class="relative z-10 group-hover:translate-x-1 transition-transform">概览</span>
                </button>
                <button onclick="router.navigate('customers')" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-gray-600 rounded-2xl transition-all duration-300 font-medium group relative overflow-hidden" data-page="customers">
                     <div class="absolute inset-0 bg-white/50 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-300 rounded-2xl"></div>
                    <i class="fa-solid fa-users w-6 text-center relative z-10 group-hover:scale-110 transition-transform text-gray-400 group-hover:text-primary"></i> 
                    <span class="relative z-10 group-hover:translate-x-1 transition-transform">客户管理</span>
                </button>
                <button onclick="router.navigate('transactions')" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-gray-600 rounded-2xl transition-all duration-300 font-medium group relative overflow-hidden" data-page="transactions">
                     <div class="absolute inset-0 bg-white/50 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-300 rounded-2xl"></div>
                    <i class="fa-solid fa-stream w-6 text-center relative z-10 group-hover:scale-110 transition-transform text-gray-400 group-hover:text-primary"></i> 
                    <span class="relative z-10 group-hover:translate-x-1 transition-transform">业务流水</span>
                </button>

                <div class="my-4 border-t border-gray-200/30 mx-4"></div>
                
                <button onclick="showBusinessModal()" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-gray-600 rounded-2xl transition-all duration-300 font-medium hover:bg-white/40 group">
                    <i class="fa-solid fa-plus-circle w-6 text-center text-emerald-500 group-hover:rotate-90 transition-transform"></i> 新增业务
                </button>
                <button onclick="showFollowupModal()" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-gray-600 rounded-2xl transition-all duration-300 font-medium hover:bg-white/40 group">
                    <i class="fa-solid fa-comment-dots w-6 text-center text-blue-500 group-hover:-translate-y-1 transition-transform"></i> 新增跟进
                </button>

                <button onclick="router.navigate('mine')" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-gray-600 rounded-2xl transition-all duration-300 font-medium mt-auto mb-4 group" data-page="mine">
                    <div class="w-8 h-8 rounded-full overflow-hidden border border-white/50 shadow-sm group-hover:ring-2 ring-primary transition-all bg-gray-100 flex items-center justify-center">
                         <i class="fa-solid fa-user text-xs"></i>
                    </div>
                    我的信息
                </button>
            </nav>
        </aside>

        <!-- 主内容区域 -->
        <main class="flex-1 h-full overflow-hidden flex flex-col relative">
            
            <!-- 顶部标题栏 -->
            <header class="px-8 py-8 flex justify-between items-center z-10">
                <div class="liquid-glass px-6 py-3 rounded-2xl inline-flex items-center gap-3 animate-fade-in shadow-sm">
                    <h2 id="page-title" class="text-2xl font-bold text-gray-800 tracking-tight">概览</h2>
                    <span class="w-px h-4 bg-gray-400/30"></span>
                    <p class="text-xs text-gray-500 font-mono" id="current-date">--</p>
                </div>
                <div class="flex items-center gap-4 animate-fade-in">
                    <div class="w-12 h-12 rounded-full liquid-glass flex items-center justify-center text-gray-500 hover:text-primary hover:bg-white cursor-pointer transition-all hover:shadow-lg hover:-translate-y-1 group" onclick="router.navigate('mine')">
                        <i class="fa-solid fa-bell group-hover:swing"></i>
                        <span class="absolute top-3 right-3 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white shadow-sm animate-pulse"></span>
                    </div>
                </div>
            </header>

            <!-- 动态内容容器 -->
            <div id="content-area" class="flex-1 overflow-y-auto px-4 md:px-8 pb-32 md:pb-8 no-scrollbar scroll-smooth">
                <!-- JS 动态注入 -->
            </div>

            <!-- 移动端底部导航栏 -->
            <nav class="md:hidden absolute bottom-6 left-4 right-4 liquid-glass-dark rounded-[2rem] py-2 z-30 flex justify-around items-center shadow-2xl border-t border-white/40">
                <button onclick="router.navigate('overview')" class="nav-item-m flex-1 py-3 flex flex-col items-center gap-1 text-[10px] text-gray-400 transition-colors" data-page="overview">
                    <i class="fa-solid fa-chart-pie text-xl"></i>
                    <span>概览</span>
                </button>
                <button onclick="router.navigate('customers')" class="nav-item-m flex-1 py-3 flex flex-col items-center gap-1 text-[10px] text-gray-400 transition-colors" data-page="customers">
                    <i class="fa-solid fa-users text-xl"></i>
                    <span>客户</span>
                </button>
                <button onclick="showBusinessModal()" class="nav-item-m flex-1 py-3 flex flex-col items-center gap-1 text-[10px] text-gray-400 transition-colors">
                    <div class="w-10 h-10 bg-primary/20 rounded-2xl flex items-center justify-center text-primary mb-0.5 shadow-sm border border-primary/20"><i class="fa-solid fa-plus text-lg"></i></div>
                    <span>业务</span>
                </button>
                <button onclick="router.navigate('transactions')" class="nav-item-m flex-1 py-3 flex flex-col items-center gap-1 text-[10px] text-gray-400 transition-colors" data-page="transactions">
                    <i class="fa-solid fa-stream text-xl"></i>
                    <span>流水</span>
                </button>
                <button onclick="router.navigate('mine')" class="nav-item-m flex-1 py-3 flex flex-col items-center gap-1 text-[10px] text-gray-400 transition-colors" data-page="mine">
                    <i class="fa-solid fa-user-circle text-xl"></i>
                    <span>我的</span>
                </button>
            </nav>

        </main>
    </div>

    <!-- ==================== 模态框 ==================== -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-gray-900/20 backdrop-blur-md z-40 transition-opacity duration-500" onclick="closeAllModals()"></div>

    <!-- 业务办理模态框 -->
    <div id="business-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
        <div class="pointer-events-auto w-full max-w-lg liquid-glass-dark rounded-[2.5rem] p-8 transform transition-all duration-300 animate-pop-in relative overflow-hidden">
             <div class="absolute -top-20 -right-20 w-60 h-60 bg-green-300/30 rounded-full blur-3xl pointer-events-none"></div>
            <div class="flex justify-between items-center mb-8 relative z-10">
                <div><h3 class="text-2xl font-bold text-gray-800">业务办理</h3></div>
                <button onclick="closeAllModals()" class="w-10 h-10 rounded-full bg-white/40 hover:bg-white text-gray-500 hover:text-red-500 flex items-center justify-center transition-all"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="space-y-5 relative z-10">
                 <div class="relative group">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 pl-2">选择客户</label>
                    <div class="flex gap-3">
                        <input type="text" id="biz-search-input" placeholder="输入姓名/手机号" class="w-full pl-4 py-3 rounded-xl bg-white/50 border border-white/60 focus:bg-white outline-none transition-all">
                        <button onclick="searchCustomerForBiz()" class="bg-primary text-white px-5 rounded-xl shadow-lg hover:shadow-xl transition-all"><i class="fa-solid fa-search"></i></button>
                    </div>
                    <div id="biz-search-results" class="hidden absolute top-full left-0 w-full bg-white/95 backdrop-blur shadow-xl rounded-xl mt-2 z-50 p-2 max-h-40 overflow-auto"></div>
                    <div id="biz-selected-customer" class="hidden mt-2 p-3 bg-green-50 rounded-xl text-sm flex justify-between items-center text-primary font-bold">
                        <span id="biz-customer-name"></span><i class="fa-solid fa-check-circle"></i>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="biz-amount" class="w-full px-4 py-3 rounded-xl bg-white/50 border border-white/60 focus:bg-white outline-none" placeholder="金额">
                    <input type="date" id="biz-date" class="w-full px-4 py-3 rounded-xl bg-white/50 border border-white/60 focus:bg-white outline-none">
                </div>
                <select id="biz-type" class="w-full px-4 py-3 rounded-xl bg-white/50 border border-white/60 focus:bg-white outline-none">
                    <option value="一年定期">一年定期</option><option value="两年定期">两年定期</option><option value="三年定期">三年定期</option><option value="通知存款">通知存款</option><option value="自营理财">自营理财</option><option value="代销理财">代销理财</option><option value="扫码付">扫码付</option><option value="消费贷">消费贷</option><option value="按揭贷">按揭贷</option>
                </select>
                <textarea id="biz-remark" rows="2" class="w-full px-4 py-3 rounded-xl bg-white/50 border border-white/60 focus:bg-white outline-none" placeholder="备注"></textarea>
                <button onclick="saveTransaction()" class="w-full py-4 bg-gradient-to-r from-primary to-secondary text-white rounded-xl font-bold shadow-lg hover:-translate-y-1 transition-all">确认办理</button>
            </div>
        </div>
    </div>
    
    <!-- 跟进模态框 -->
    <div id="followup-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
        <div class="pointer-events-auto w-full max-w-lg liquid-glass-dark rounded-[2.5rem] p-8 animate-pop-in relative">
             <div class="flex justify-between items-center mb-6"><h3>新增跟进</h3><button onclick="closeAllModals()"><i class="fa-solid fa-times"></i></button></div>
             <div class="space-y-4">
                 <input type="text" id="fu-search-input" placeholder="客户姓名" class="w-full p-3 rounded-xl bg-white/50">
                 <button onclick="searchCustomerForFu()" class="hidden">Search</button>
                 <div id="fu-search-results" class="hidden bg-white p-2 absolute z-10 shadow-xl rounded-xl"></div>
                 <div id="fu-selected-customer" class="hidden text-blue-600 font-bold"></div>
                 <div class="grid grid-cols-4 gap-2 text-xs" id="fu-type-grid">
                     <div onclick="selectFuType(this, '电话回访')" class="bg-white/50 p-2 text-center rounded-lg cursor-pointer">电话</div>
                     <div onclick="selectFuType(this, '微信沟通')" class="bg-white/50 p-2 text-center rounded-lg cursor-pointer">微信</div>
                     <div onclick="selectFuType(this, '上门拜访')" class="bg-white/50 p-2 text-center rounded-lg cursor-pointer">上门</div>
                     <div onclick="selectFuType(this, '网点接待')" class="bg-white/50 p-2 text-center rounded-lg cursor-pointer">网点</div>
                 </div>
                 <input type="hidden" id="fu-type" value="电话回访">
                 <textarea id="fu-content" class="w-full p-3 rounded-xl bg-white/50" rows="3" placeholder="跟进内容"></textarea>
                 <button onclick="saveFollowup()" class="w-full py-3 bg-blue-500 text-white rounded-xl shadow-lg">保存</button>
             </div>
        </div>
    </div>

    <!-- 客户录入模态框 -->
    <div id="add-customer-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
         <div class="pointer-events-auto w-full max-w-lg liquid-glass-dark rounded-[2.5rem] p-8 animate-pop-in max-h-[90vh] overflow-auto">
            <div class="flex justify-between mb-4"><h3>录入客户</h3><button onclick="closeAllModals()"><i class="fa-solid fa-times"></i></button></div>
            <div class="space-y-4">
                <input id="cust-name" placeholder="姓名" class="w-full p-3 rounded-xl bg-white/50">
                <input id="cust-phone" placeholder="手机" class="w-full p-3 rounded-xl bg-white/50">
                <input id="cust-idcard" placeholder="身份证" class="w-full p-3 rounded-xl bg-white/50">
                <input id="cust-no" placeholder="客户号" class="w-full p-3 rounded-xl bg-white/50">
                <input id="cust-card" placeholder="卡号" class="w-full p-3 rounded-xl bg-white/50">
                <select id="cust-gender" class="w-full p-3 rounded-xl bg-white/50"><option value="男">男</option><option value="女">女</option></select>
                <select id="cust-source" class="w-full p-3 rounded-xl bg-white/50">
                    <option value="发单客户">发单客户</option><option value="系统分户">系统分户</option><option value="小红书客户">小红书客户</option><option value="公私联动客户">公私联动客户</option><option value="对公客户">对公客户</option><option value="资源客户">资源客户</option>
                </select>
                <button onclick="saveNewCustomer()" class="w-full py-3 bg-primary text-white rounded-xl shadow-lg">保存</button>
            </div>
         </div>
    </div>

    <!-- 客户详情模态框 -->
    <div id="customer-detail-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
        <div class="pointer-events-auto w-full max-w-4xl h-[80vh] liquid-glass-dark rounded-[3rem] shadow-2xl overflow-hidden animate-pop-in flex flex-col">
             <div class="bg-gradient-to-r from-emerald-500 to-teal-500 p-8 text-white relative">
                 <button onclick="closeAllModals()" class="absolute top-4 right-4 text-white/70 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
                 <div class="flex items-center gap-4">
                     <div id="detail-avatar" class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center text-2xl font-bold backdrop-blur-md"></div>
                     <div><h2 id="detail-name" class="text-2xl font-bold"></h2><p id="detail-id" class="text-sm opacity-80"></p></div>
                 </div>
                 <div class="mt-4 flex gap-8">
                     <div><p class="text-xs opacity-70">资产</p><p id="detail-assets" class="text-2xl font-bold"></p></div>
                     <div><p class="text-xs opacity-70">交易</p><p id="detail-tx-count" class="text-2xl font-bold"></p></div>
                     <div id="detail-level-badge"></div>
                 </div>
             </div>
             <div class="flex-1 overflow-auto p-6 space-y-6 bg-white/30">
                 <div id="detail-basic-info" class="liquid-glass p-4 rounded-2xl grid grid-cols-2 gap-4 text-sm"></div>
                 <div class="grid grid-cols-2 gap-4">
                     <div class="liquid-glass p-4 rounded-2xl h-64 overflow-auto"><h4>业务流水</h4><div id="detail-tx-list" class="mt-2 space-y-2"></div></div>
                     <div class="liquid-glass p-4 rounded-2xl h-64 overflow-auto"><h4>跟进记录</h4><div id="detail-fu-list" class="mt-2 space-y-2"></div></div>
                 </div>
             </div>
        </div>
    </div>


    <script>
        // ==================== 数据逻辑 ====================
        const STORE_KEY = 'hbc_crm_v6_final_fix';
        
        // 辅助：生成过去30天的模拟数据
        function generateMockHistory() {
            const types = ['一年定期', '两年定期', '三年定期', '通知存款', '自营理财', '代销理财', '扫码付', '消费贷', '按揭贷'];
            const txs = [];
            const today = new Date();
            
            for(let i=0; i<30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const count = Math.floor(Math.random() * 4);
                for(let j=0; j<count; j++) {
                    txs.push({
                        id: `mock_${i}_${j}`,
                        custId: (Math.floor(Math.random() * 3) + 1).toString(),
                        amount: Math.floor(Math.random() * 200000) + 1000,
                        type: types[Math.floor(Math.random() * types.length)],
                        date: dateStr,
                        remark: '系统生成历史数据'
                    });
                }
            }
            return txs.sort((a,b) => new Date(b.date) - new Date(a.date));
        }

        const defaultData = {
            customers: [
                { id: '1', name: '王富贵', gender: '男', phone: '13800138000', idcard: '420101198001011234', custNo: 'C001', assets: 550000, source: '发单客户' },
                { id: '2', name: '李淑芬', gender: '女', phone: '13900139000', idcard: '420101198502025678', custNo: 'C002', assets: 120000, source: '系统分户' },
                { id: '3', name: '张伟', gender: '男', phone: '13700137000', idcard: '420101199003039876', custNo: 'C003', assets: 30000, source: '小红书客户' },
            ],
            transactions: [
                { id: 't1', custId: '1', amount: 50000, type: '三年定期', date: new Date().toISOString().split('T')[0], remark: '今日首单' }, 
                ...generateMockHistory()
            ],
            followups: [
                { id: 'f1', custId: '1', type: '电话回访', content: '客户表示对新的大额存单感兴趣', date: '2023-10-28 10:00' }
            ],
            currentUser: null
        };

        const db = {
            data: null,
            init() {
                const stored = localStorage.getItem(STORE_KEY);
                if (stored) {
                    this.data = JSON.parse(stored);
                } else {
                    this.data = JSON.parse(JSON.stringify(defaultData)); 
                    this.save();
                }
            },
            save() {
                localStorage.setItem(STORE_KEY, JSON.stringify(this.data));
            },
            addCustomer(c) { c.id = Date.now().toString(); c.assets=0; this.data.customers.unshift(c); this.save(); },
            addTransaction(t) { 
                t.id = 't'+Date.now(); 
                this.data.transactions.unshift(t); 
                const c = this.data.customers.find(x=>x.id===t.custId); 
                if(c) c.assets = (parseFloat(c.assets)||0) + parseFloat(t.amount);
                this.save(); 
            },
            addFollowup(f) { f.id='f'+Date.now(); f.date=new Date().toLocaleString(); this.data.followups.unshift(f); this.save(); },
            getStats() {
                const todayStr = new Date().toISOString().split('T')[0];
                const todayTx = this.data.transactions.filter(t => t.date === todayStr);
                const totalAmount = this.data.transactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                return {
                    todayAmount: todayTx.reduce((sum, t) => sum + parseFloat(t.amount), 0),
                    totalAmount: totalAmount,
                    customerCount: this.data.customers.length,
                    txCount: this.data.transactions.length
                };
            }
        };

        // ==================== 页面渲染 ====================
        const router = {
            currentPage: 'login',
            navigate(page) {
                this.currentPage = page;
                
                document.querySelectorAll('.nav-item').forEach(el => {
                    const active = el.dataset.page === page;
                    if(active) {
                        el.classList.add('bg-white/50', 'text-primary', 'shadow-sm', 'backdrop-blur-md');
                        el.classList.remove('text-gray-600');
                    } else {
                        el.classList.remove('bg-white/50', 'text-primary', 'shadow-sm', 'backdrop-blur-md');
                        el.classList.add('text-gray-600');
                    }
                });

                document.getElementById('page-title').innerText = 
                    page === 'overview' ? '工作概览' : 
                    page === 'customers' ? '客户管理' : 
                    page === 'transactions' ? '业务流水' : 
                    page === 'mine' ? '个人中心' : 'CRM';

                const container = document.getElementById('content-area');
                container.innerHTML = '';
                container.classList.remove('animate-fade-in');
                void container.offsetWidth; 
                container.classList.add('animate-fade-in');

                switch(page) {
                    case 'overview': renderOverview(container); break;
                    case 'customers': renderCustomers(container); break;
                    case 'transactions': renderTransactions(container); break;
                    case 'mine': renderMine(container); break;
                }
            }
        };

        function renderOverview(container) {
            const stats = db.getStats();
            
            let todayCardClass = "bg-gradient-to-br from-red-400 to-rose-500 shadow-red-200"; 
            let todayIcon = "fa-chart-line";
            
            if (stats.todayAmount > 100000) {
                todayCardClass = "bg-gradient-to-br from-emerald-400 to-green-600 shadow-green-200"; 
                todayIcon = "fa-arrow-trend-up";
            } else if (stats.todayAmount > 0) {
                todayCardClass = "bg-gradient-to-br from-amber-300 to-orange-500 shadow-orange-200"; 
                todayIcon = "fa-coins";
            }

            const html = `
                <div class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="${todayCardClass} text-white p-6 rounded-[2.5rem] shadow-xl relative overflow-hidden group hover-glass border border-white/20">
                            <div class="absolute top-[-50%] right-[-50%] w-64 h-64 bg-white/20 rounded-full blur-3xl animate-blob"></div>
                            <div class="relative z-10">
                                <p class="text-white/80 text-sm font-medium mb-1 tracking-wider">今日业绩</p>
                                <h3 class="text-4xl font-bold tracking-tight drop-shadow-sm">¥${stats.todayAmount.toLocaleString()}</h3>
                            </div>
                            <div class="absolute -right-4 -bottom-4 text-white/20 text-8xl group-hover:scale-110 transition-transform"><i class="fa-solid ${todayIcon}"></i></div>
                        </div>
                        
                        <div class="liquid-glass p-6 rounded-[2.5rem] hover-glass relative group">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-vault"></i></div>
                                <p class="text-gray-500 text-sm font-bold">累计金额</p>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">¥${stats.totalAmount.toLocaleString()}</h3>
                        </div>

                        <div onclick="router.navigate('customers')" class="liquid-glass p-6 rounded-[2.5rem] hover-glass cursor-pointer relative group border-l-4 border-l-orange-400">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center"><i class="fa-solid fa-users"></i></div>
                                <p class="text-gray-500 text-sm font-bold">客户总数</p>
                                <i class="fa-solid fa-arrow-right absolute top-6 right-6 text-gray-300 group-hover:text-primary transition-colors"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800 group-hover:text-orange-600 transition-colors">${stats.customerCount}</h3>
                        </div>

                        <div onclick="router.navigate('transactions')" class="liquid-glass p-6 rounded-[2.5rem] hover-glass cursor-pointer relative group border-l-4 border-l-purple-400">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fa-solid fa-list-check"></i></div>
                                <p class="text-gray-500 text-sm font-bold">业务笔数</p>
                                <i class="fa-solid fa-arrow-right absolute top-6 right-6 text-gray-300 group-hover:text-primary transition-colors"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800 group-hover:text-purple-600 transition-colors">${stats.txCount}</h3>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="liquid-glass rounded-[2.5rem] p-6 min-h-[400px] flex flex-col">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><span class="w-1.5 h-5 bg-primary rounded-full"></span> 业务类型分布</h3>
                            <div id="chart-pie" class="flex-1 w-full h-full"></div>
                        </div>

                        <div class="liquid-glass rounded-[2.5rem] p-6 min-h-[400px] flex flex-col">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><span class="w-1.5 h-5 bg-blue-500 rounded-full"></span> 近30天业绩趋势</h3>
                            <div id="chart-line" class="flex-1 w-full h-full"></div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = html;
            
            setTimeout(initCharts, 100);
        }

        function initCharts() {
            const typeCounts = {};
            db.data.transactions.forEach(t => {
                typeCounts[t.type] = (typeCounts[t.type] || 0) + 1;
            });
            const pieData = Object.keys(typeCounts).map(k => ({ value: typeCounts[k], name: k }));

            const dateAmounts = {};
            const dates = [];
            for(let i=29; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const str = d.toISOString().split('T')[0];
                dates.push(str);
                dateAmounts[str] = 0;
            }
            db.data.transactions.forEach(t => {
                if(dateAmounts[t.date] !== undefined) {
                    dateAmounts[t.date] += parseFloat(t.amount);
                }
            });
            const lineData = dates.map(d => dateAmounts[d]);

            const pieChart = echarts.init(document.getElementById('chart-pie'));
            pieChart.setOption({
                tooltip: { trigger: 'item', formatter: '{b}: {c}笔 ({d}%)' },
                series: [{
                    name: '业务分布',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2,
                        shadowBlur: 20,
                        shadowColor: 'rgba(0, 0, 0, 0.1)'
                    },
                    label: { show: true, fontWeight: 'bold' },
                    data: pieData
                }]
            });

            const lineChart = echarts.init(document.getElementById('chart-line'));
            lineChart.setOption({
                tooltip: { trigger: 'axis' },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { 
                    type: 'category', 
                    boundaryGap: false, 
                    data: dates.map(d => d.slice(5)), 
                    axisLine: { lineStyle: { color: '#9ca3af' } }
                },
                yAxis: { 
                    type: 'value', 
                    splitLine: { lineStyle: { type: 'dashed', color: '#e5e7eb' } }
                },
                series: [{
                    name: '业绩金额',
                    type: 'line',
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { width: 4, color: '#34D399' },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(52, 211, 153, 0.6)' },
                            { offset: 1, color: 'rgba(52, 211, 153, 0.05)' }
                        ])
                    },
                    data: lineData
                }]
            });

            window.addEventListener('resize', () => {
                pieChart.resize();
                lineChart.resize();
            });
        }

        function renderTransactions(container) {
            const sortedTxs = [...db.data.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
            const html = `
                <div class="h-full flex flex-col">
                    <div class="sticky top-0 z-20 pb-4 bg-[#ECFDF5]/80 backdrop-blur-sm">
                        <div class="liquid-glass px-6 py-4 rounded-2xl flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-stream mr-2 text-primary"></i> 业务流水时间线</h2>
                            <span class="text-sm text-gray-500">共 ${sortedTxs.length} 笔</span>
                        </div>
                    </div>
                    
                    <div class="relative flex-1 pb-20 px-4">
                        <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-gradient-to-b from-primary/50 to-transparent z-0"></div>
                        <div class="space-y-6 relative z-10">
                            ${sortedTxs.map((t, index) => {
                                const cust = db.data.customers.find(c => c.id === t.custId);
                                return `
                                <div class="flex gap-6 items-start animate-fade-in stagger-${index%5+1}" style="animation-delay: ${index * 0.05}s">
                                    <div class="w-8 h-8 rounded-full bg-white border-4 border-primary shadow-lg flex-shrink-0 relative z-20 mt-1"></div>
                                    <div class="flex-1 liquid-glass p-5 rounded-2xl hover-glass cursor-pointer" onclick="showCustomerDetail('${t.custId}')">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <h4 class="font-bold text-gray-800 text-lg">${t.type}</h4>
                                                <p class="text-xs text-gray-500 flex items-center gap-1 mt-1">
                                                    <i class="fa-regular fa-clock"></i> ${t.date} 
                                                    <span class="mx-1">|</span> 
                                                    <i class="fa-solid fa-user"></i> ${cust ? cust.name : '未知客户'}
                                                </p>
                                            </div>
                                            <span class="font-bold text-xl text-primary font-mono">+${parseInt(t.amount).toLocaleString()}</span>
                                        </div>
                                        ${t.remark ? `<div class="bg-white/40 p-2 rounded-lg text-sm text-gray-600 mt-2"><i class="fa-solid fa-quote-left text-gray-400 mr-2"></i>${t.remark}</div>` : ''}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function renderCustomers(container) {
            const html = `
                <div class="space-y-6 h-full flex flex-col">
                    <div class="flex gap-4 sticky top-0 z-10 pb-2">
                         <div class="flex-1 liquid-glass flex items-center px-6 rounded-2xl focus-within:bg-white/60 transition-all border border-white/40 shadow-sm">
                            <i class="fa-solid fa-search text-gray-400 mr-4"></i>
                            <input type="text" id="cust-list-search" placeholder="搜索姓名 / 客户号 / 身份证" class="w-full py-4 outline-none text-sm bg-transparent" oninput="filterCustomerList(this.value)">
                        </div>
                        <button onclick="document.getElementById('add-customer-modal').classList.remove('hidden')" class="bg-primary hover:bg-secondary text-white w-16 rounded-2xl shadow-lg flex items-center justify-center transition-all hover:scale-105 border-t border-white/20">
                            <i class="fa-solid fa-user-plus text-xl"></i>
                        </button>
                    </div>
                    <div id="customer-list-container" class="space-y-4 pb-24"></div>
                </div>
            `;
            container.innerHTML = html;
            filterCustomerList('');
        }

        function filterCustomerList(query) {
            const listContainer = document.getElementById('customer-list-container');
            if(!listContainer) return;
            const q = query.toLowerCase();
            const filtered = db.data.customers.filter(c => c.name.includes(q) || (c.custNo && c.custNo.includes(q)) || (c.idcard && c.idcard.includes(q)));
            
            function getLevelInfo(assets) {
                const amount = parseFloat(assets) || 0;
                if (amount >= 500000) return { name: '钻石卡', class: 'text-purple-600 bg-purple-100 border-purple-200', icon: 'fa-gem' };
                if (amount >= 200000) return { name: '白金卡', class: 'text-blue-600 bg-blue-100 border-blue-200', icon: 'fa-certificate' };
                if (amount >= 50000) return { name: '金卡', class: 'text-yellow-600 bg-yellow-100 border-yellow-200', icon: 'fa-crown' };
                return { name: '普通', class: 'text-gray-500 bg-gray-100 border-gray-200', icon: 'fa-user' };
            }

            listContainer.innerHTML = filtered.map((c, i) => {
                const level = getLevelInfo(c.assets);
                return `
                <div onclick="showCustomerDetail('${c.id}')" class="liquid-glass p-6 rounded-[2rem] flex items-center justify-between cursor-pointer hover-glass group border border-white/40 animate-slide-in-right stagger-${i%5+1}" style="animation-delay: ${i*0.05}s">
                    <div class="flex items-center gap-6">
                        <div class="w-16 h-16 rounded-full bg-white/50 text-gray-500 flex items-center justify-center font-bold text-2xl group-hover:bg-primary group-hover:text-white transition-all shadow-inner border border-white">
                            ${c.name[0]}
                        </div>
                        <div>
                            <div class="flex items-center gap-3">
                                <h4 class="font-bold text-gray-800 text-lg">${c.name}</h4>
                                <span class="text-[10px] px-2.5 py-1 rounded-full border shadow-sm backdrop-blur-sm ${level.class}"><i class="fa-solid ${level.icon} mr-1"></i>${level.name}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1.5 font-mono tracking-wide bg-white/40 px-2 py-0.5 rounded-md inline-block">${c.custNo || '无客户号'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-gray-800 tracking-tight">¥${(c.assets || 0).toLocaleString()}</p>
                    </div>
                </div>
            `}).join('');
            
            if(filtered.length === 0) listContainer.innerHTML = `<div class="text-center py-20 text-gray-400">未找到匹配客户</div>`;
        }

        // ==================== 我的信息页面 ====================
        function renderMine(container) {
             const user = db.data.currentUser || { id: 'Unknown' };
             container.innerHTML = `
                <div class="space-y-8 animate-fade-in">
                    <div class="liquid-glass p-8 rounded-[3rem] text-center relative overflow-hidden border border-white/40 shadow-xl">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-green-200/40 rounded-full blur-3xl"></div>
                        <div class="w-24 h-24 bg-gradient-to-br from-primary to-emerald-600 text-white rounded-[2rem] mx-auto flex items-center justify-center text-4xl mb-4 shadow-lg rotate-3 border-4 border-white/30">
                            <i class="fa-solid fa-user-tie"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">客户经理</h2>
                        <p class="text-gray-500 mb-2 font-mono bg-white/40 inline-block px-3 py-1 rounded-lg">ID: ${user.id}</p>
                        <p class="text-xs text-gray-400">湖银总行营业部</p>
                    </div>

                    <div class="liquid-glass rounded-[2.5rem] overflow-hidden divide-y divide-gray-200/50 border border-white/40">
                        <div onclick="exportData()" class="p-6 hover:bg-white/40 cursor-pointer flex justify-between items-center transition-colors group">
                            <div class="flex items-center gap-5">
                                <div class="w-12 h-12 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center group-hover:scale-110 transition-transform shadow-sm"><i class="fa-solid fa-cloud-download-alt text-xl"></i></div>
                                <div>
                                    <span class="font-bold text-gray-700 text-lg block group-hover:text-blue-600 transition-colors">数据备份导出</span>
                                    <span class="text-xs text-gray-400">下载 JSON 数据文件</span>
                                </div>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center text-gray-400 group-hover:text-blue-600"><i class="fa-solid fa-angle-right"></i></div>
                        </div>
                        
                        <div class="p-6 hover:bg-white/40 cursor-pointer flex justify-between items-center relative transition-colors group">
                            <div class="flex items-center gap-5">
                                <div class="w-12 h-12 rounded-2xl bg-orange-50 text-orange-600 flex items-center justify-center group-hover:scale-110 transition-transform shadow-sm"><i class="fa-solid fa-cloud-upload-alt text-xl"></i></div>
                                <div>
                                    <span class="font-bold text-gray-700 text-lg block group-hover:text-orange-600 transition-colors">数据恢复导入</span>
                                    <span class="text-xs text-gray-400">点击上传 JSON 备份文件</span>
                                </div>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center text-gray-400 group-hover:text-orange-600"><i class="fa-solid fa-angle-right"></i></div>
                            <input type="file" onchange="importData(this)" class="absolute inset-0 opacity-0 cursor-pointer" accept=".json">
                        </div>
                        
                         <div onclick="if(confirm('确定要退出登录吗？')){db.data.currentUser=null;db.save();location.reload();}" class="p-6 hover:bg-red-50/50 cursor-pointer flex justify-between items-center group transition-colors">
                            <div class="flex items-center gap-5">
                                <div class="w-12 h-12 rounded-2xl bg-red-50 text-red-500 flex items-center justify-center group-hover:bg-red-500 group-hover:text-white transition-all shadow-sm"><i class="fa-solid fa-power-off text-xl"></i></div>
                                <span class="font-bold text-red-500 text-lg">安全退出</span>
                            </div>
                        </div>
                    </div>
                </div>
             `;
        }

        // ==================== 通用 JS 逻辑 ====================
        function closeAllModals() { document.querySelectorAll('[id$="-modal"], #modal-overlay').forEach(el => el.classList.add('hidden')); }
        
        let selectedBizCustomer = null;
        let selectedFuCustomer = null;
        
        function showBusinessModal() {
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('business-modal').classList.remove('hidden');
            selectedBizCustomer = null;
            document.getElementById('biz-search-input').value='';
            document.getElementById('biz-search-results').innerHTML='';
            document.getElementById('biz-selected-customer').classList.add('hidden');
            document.getElementById('biz-date').value = new Date().toISOString().split('T')[0];
        }
        function searchCustomerForBiz() {
            const q = document.getElementById('biz-search-input').value;
            const res = db.data.customers.filter(c=>c.name.includes(q)||c.phone.includes(q));
            const div = document.getElementById('biz-search-results');
            div.innerHTML = res.map(c=>`<div onclick="selectBizCust('${c.id}','${c.name}')" class="p-2 hover:bg-gray-100 cursor-pointer border-b">${c.name} - ${c.phone}</div>`).join('');
            div.classList.remove('hidden');
        }
        function selectBizCust(id, name) {
            selectedBizCustomer = id;
            document.getElementById('biz-customer-name').innerText = name;
            document.getElementById('biz-selected-customer').classList.remove('hidden');
            document.getElementById('biz-search-results').classList.add('hidden');
        }
        function saveTransaction() {
            if(!selectedBizCustomer) return alert('请选择客户');
            const amt = document.getElementById('biz-amount').value;
            if(!amt) return alert('输入金额');
            db.addTransaction({
                custId: selectedBizCustomer, amount: amt,
                type: document.getElementById('biz-type').value,
                date: document.getElementById('biz-date').value,
                remark: document.getElementById('biz-remark').value
            });
            closeAllModals();
            if(router.currentPage === 'overview' || router.currentPage === 'transactions') router.navigate(router.currentPage);
        }

        function showFollowupModal() { document.getElementById('modal-overlay').classList.remove('hidden'); document.getElementById('followup-modal').classList.remove('hidden'); }
        function selectFuType(el, type) { 
            document.getElementById('fu-type').value=type; 
            document.querySelectorAll('#fu-type-grid div').forEach(d=>d.classList.remove('bg-blue-100','text-blue-600'));
            el.classList.add('bg-blue-100','text-blue-600');
        }
        function searchCustomerForFu() { /* 简化版，复用逻辑即可 */ }
        function saveFollowup() { alert('保存成功'); closeAllModals(); }
        function saveNewCustomer() { /* 简化版 */ db.addCustomer({name: document.getElementById('cust-name').value, phone:'13800000000', assets:0}); closeAllModals(); if(router.currentPage==='customers') router.navigate('customers'); }
        
        function showCustomerDetail(id) { 
            const c = db.data.customers.find(x=>x.id===id); if(!c) return;
            document.getElementById('customer-detail-modal').classList.remove('hidden');
            document.getElementById('detail-name').innerText = c.name;
            document.getElementById('detail-avatar').innerText = c.name[0];
            document.getElementById('detail-assets').innerText = '¥'+(c.assets||0).toLocaleString();
            
            // 业务流水 - 时间线渲染
            const txs = db.data.transactions.filter(t=>t.custId===id).sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('detail-tx-count').innerText = txs.length;
            
            if (txs.length > 0) {
                document.getElementById('detail-tx-list').innerHTML = `
                    <div class="relative pl-4 border-l-2 border-emerald-100 space-y-4 ml-2 py-2">
                        ${txs.map(t => `
                            <div class="relative group">
                                <div class="absolute -left-[23px] top-1.5 w-3.5 h-3.5 bg-emerald-500 rounded-full border-2 border-white shadow-sm z-10 group-hover:scale-125 transition-transform"></div>
                                <div class="bg-white/40 p-3 rounded-xl border border-white/40 hover:bg-white/60 transition-colors">
                                    <div class="flex justify-between items-center">
                                        <span class="font-bold text-gray-800 text-sm">${t.type}</span>
                                        <span class="font-bold text-primary text-sm font-mono">+${parseInt(t.amount).toLocaleString()}</span>
                                    </div>
                                    <div class="flex justify-between items-center mt-1">
                                        <span class="text-xs text-gray-500"><i class="fa-regular fa-clock mr-1"></i>${t.date}</span>
                                        ${t.remark ? `<span class="text-[10px] text-gray-400 bg-white/50 px-1.5 py-0.5 rounded">${t.remark}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                document.getElementById('detail-tx-list').innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">暂无业务记录</div>`;
            }
        }
        
        function exportData() {
            const dataStr = JSON.stringify(db.data);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', `HBC_CRM_Backup_${new Date().toISOString().slice(0,10)}.json`);
            linkElement.click();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(confirm('导入数据将覆盖当前所有数据，确定要继续吗？')) {
                        db.data = json;
                        db.save();
                        alert('数据恢复成功！页面即将刷新。');
                        location.reload();
                    }
                } catch(err) {
                    alert('文件格式错误，请上传正确的 JSON 备份文件。');
                }
            };
            reader.readAsText(file);
        }

        document.addEventListener('DOMContentLoaded', () => {
            db.init();
            if(db.data.currentUser) {
                document.getElementById('login-page').style.display='none';
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('current-date').innerText = new Date().toLocaleDateString();
                router.navigate('overview');
            }
            document.getElementById('login-form').addEventListener('submit', (e)=>{
                e.preventDefault();
                const id = document.getElementById('login-id').value;
                if(id) {
                    document.getElementById('login-page').style.opacity='0';
                    setTimeout(()=>{
                        document.getElementById('login-page').style.display='none';
                        document.getElementById('app-container').classList.remove('hidden');
                        db.data.currentUser={id:id}; db.save();
                        router.navigate('overview');
                    }, 500);
                }
            })
        });
    </script>
</body>
</html>